# This workflow will build the documentation.
#
# Edward Hartnett, 9/16/24

name: docs

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  docs:

    runs-on: ubuntu-latest

    steps:
    - name: checkout
      uses: actions/checkout@v4
      with:
        path: rrfs-workflow
        submodules: true

    - name: cache-esmf
      id: cache-esmf
      uses: actions/cache@v2
      with:
        path: ~/esmf
        key: developer-esmf-8.2.0-${{ runner.os }}3

    - name: build-esmf
      if: steps.cache-esmf.outputs.cache-hit != 'true'
      run: |
        pushd ~
        export ESMF_DIR=~/esmf-ESMF_8_2_0
        wget https://github.com/esmf-org/esmf/archive/ESMF_8_2_0.tar.gz &> /dev/null
        tar zxf ESMF_8_2_0.tar.gz
        cd esmf-ESMF_8_2_0
        export ESMF_COMM=mpich3
        export ESMF_INSTALL_BINDIR=bin
        export ESMF_INSTALL_LIBDIR=lib
        export ESMF_INSTALL_MODDIR=mod
        export ESMF_COMPILER=gfortran
        export ESMF_INSTALL_PREFIX=~/esmf
        export ESMF_NETCDF=split
        export ESMF_NETCDF_INCLUDE=/usr/include
        export ESMF_NETCDF_LIBPATH=/usr/x86_64-linux-gnu
        make -j2
        make install

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinxcontrib-bibtex sphinx-rtd-theme numpy matplotlib pandas cartopy 
        pip install pandas cartopy f90nml netCDF4 xarray scipy 
    - name: Build docs
      run: |
        cd rrfs-workflow/doc/UsersGuide
        sphinx-apidoc -o source/ ../../ush/
        sphinx-build -W --keep-going source build
    - uses: actions/upload-artifact@v4
      with:
        name: rrfs-workflow docs
        path: |
          rrfs-workflow/doc/UsersGuide/build
        
