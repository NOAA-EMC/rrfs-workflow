{#

This is a Jinja-enabled Rocoto XML template. It is filled in using the
fill_template.py script, and is done automatically by the
generate_workflow.sh step of preparing a regional workflow configured
experiment.

See README.xml_templating.md for information on using the Templating mechanisms.
-#}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE workflow [

<!--
Parameters needed by the job scheduler.
-->
<!ENTITY ACCOUNT         "{{ account }}">
<!ENTITY SERVICE_ACCOUNT "{{ service_account }}">
<!ENTITY SCHED           "{{ sched }}">
<!ENTITY QUEUE_DEFAULT   "{{ queue_default }}">
<!ENTITY QUEUE_HPSS      "{{ queue_hpss }}">
<!ENTITY QUEUE_FCST      "{{ queue_fcst }}">
<!ENTITY QUEUE_WGRIB2    "{{ queue_wgrib2 }}">
<!ENTITY QUEUE_ANALYSIS  "{{ queue_analysis }}">
<!ENTITY QUEUE_GRAPHICS  "{{ queue_graphics }}">
<!ENTITY RRFS_RESERVE  {% if reservation %}"--reservation={{ reservation }}"{% else %}""{% endif %}>

<!--
Workflow task names.
-->
<!ENTITY MAKE_GRID_TN      "{{ make_grid_tn }}">
<!ENTITY MAKE_OROG_TN      "{{ make_orog_tn }}">
<!ENTITY MAKE_SFC_CLIMO_TN "{{ make_sfc_climo_tn }}">
<!ENTITY GET_EXTRN_ICS_TN  "{{ get_extrn_ics_tn }}">
<!ENTITY GET_EXTRN_LBCS_TN "{{ get_extrn_lbcs_tn }}">
<!ENTITY GET_EXTRN_LBCS_LONG_TN "{{ get_extrn_lbcs_long_tn }}">
<!ENTITY MAKE_ICS_TN       "{{ make_ics_tn }}">
<!ENTITY MAKE_LBCS_TN      "{{ make_lbcs_tn }}">
<!ENTITY RUN_FCST_TN       "{{ run_fcst_tn }}">
<!ENTITY RUN_POST_TN       "{{ run_post_tn }}">
<!ENTITY RUN_WGRIB2_TN     "{{ run_wgrib2_tn }}">
<!ENTITY ANAL_GSI_TN       "{{ anal_gsi }}">
<!ENTITY OBSERVER_GSI_ENSMEAN_TN       "{{ observer_gsi_ensmean }}">
<!ENTITY OBSERVER_GSI_TN       "{{ observer_gsi }}">
<!ENTITY PREP_CYC_SPINUP_TN "{{ prep_cyc_spinup }}">
<!ENTITY PREP_CYC_PROD_TN  "{{ prep_cyc_prod }}">
<!ENTITY PREP_CYC_ENSMEAN_TN  "{{ prep_cyc_ensmean }}">
<!ENTITY PREP_CYC_TN  "{{ prep_cyc }}">

<!ENTITY PROCESS_RADAR_REF_TN "{{ process_radarref }}">
<!ENTITY PROCESS_LIGHTNING_TN "{{ process_lightning }}">
<!ENTITY PROCESS_BUFR_TN      "{{ process_bufr }}">
<!ENTITY RADAR_REFL2TTEN_TN   "{{ radar_refl2tten }}">
<!ENTITY CLDANL_NONVAR_TN     "{{ cldanl_nonvar }}">

<!ENTITY RUN_PREPSTART_TN     "run_prepstart">
<!ENTITY RUN_ANAL_TN          "run_anal_gsi">
<!ENTITY RUN_ENKFUPDT_TN      "run_enkfupdt">
<!ENTITY RUN_BUFR_TN          "run_bufr">
<!ENTITY RUN_NCL_TN           "run_ncl">
<!ENTITY RUN_NCL_ZIP_TN       "run_ncl_zip">
<!ENTITY CLEAN_TN             "run_clean">
<!ENTITY ARCHIVE_TN           "run_archive">

<!ENTITY TAG                  "{{ tag }}">

<!--
Flags that specify whether to run the preprocessing tasks.
-->
<!ENTITY RUN_TASK_MAKE_GRID      "{{ run_task_make_grid | upper }}">
<!ENTITY RUN_TASK_MAKE_OROG      "{{ run_task_make_orog | upper }}">
<!ENTITY RUN_TASK_MAKE_SFC_CLIMO "{{ run_task_make_sfc_climo | upper }}">

<!--
Number of physical cores per node for the current machine.  This is used
below in the <nodesize> tag, but that tag is not clearly documented.  This
parameter may be unnecessary since each task now has its own variable that
specifies the number of processes per node being used (the PPN_... entities).
-->
<!ENTITY NCORES_PER_NODE "{{ ncores_per_node }}">

<!--
Directories and files.
-->
<!ENTITY JOBSDIR                  "{{ jobsdir }}">
<!ENTITY LOGDIR                   "{{ logdir }}">
<!ENTITY OBSPATH                  "{{ obspath }}">
<!ENTITY CYCLE_BASEDIR            "{{ cycle_basedir }}">
<!ENTITY NWGES_BASEDIR            "{{ nwges_basedir }}">
{%- if is_rtma %}
<!ENTITY FG_ROOT                  "{{ fg_rootdir }}">
{%- else %}
<!ENTITY FG_ROOT                  "{{ nwges_basedir }}">
{%- endif %}
<!ENTITY GLOBAL_VAR_DEFNS_FP      "{{ global_var_defns_fp }}">
<!ENTITY LOAD_MODULES_RUN_TASK_FP "{{ load_modules_run_task_fp }}">

<!--
Reservation types.  Reservations specify the queue/partition and account
to use for a given task.  The "DEFAULT" reservation type is used for all 
tasks other than GET_EXTRN_ICS_TN, GET_EXTRN_LBCS_TN, and RUN_FCST_TN; 
the "HPSS" type is used for the GET_EXTRN_ICS_TN and GET_EXTRN_LBCS_TN 
tasks; and the "FCST" type is used for the RUN_FCST_TN task.
-->
{%- if partition_default is not none %}
<!ENTITY RSRV_DEFAULT "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue><partition>{{ partition_default }}</partition><native>&RRFS_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_DEFAULT "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue>">
{%- endif %}
{%- if partition_hpss is not none %}
<!ENTITY RSRV_HPSS    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_HPSS;</queue><partition>{{ partition_hpss }}</partition><native>&RRFS_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_HPSS    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_HPSS;</queue>">
{%- endif %}
{%- if partition_fcst is not none %}
<!ENTITY RSRV_FCST    "<account>&ACCOUNT;</account><queue>&QUEUE_FCST;</queue><partition>{{ partition_fcst }}</partition>">
{%- else %}
<!ENTITY RSRV_FCST    "<account>&ACCOUNT;</account><queue>&QUEUE_FCST;</queue>">
{%- endif %}
{%- if partition_analysis is not none %}
<!ENTITY RSRV_ANALYSIS    "<account>&ACCOUNT;</account><queue>&QUEUE_ANALYSIS;</queue><partition>{{ partition_analysis }}</partition>">
{%- else %}
<!ENTITY RSRV_ANALYSIS    "<account>&ACCOUNT;</account><queue>&QUEUE_ANALYSIS;</queue>">
{%- endif %}
{%- if partition_wgrib2 is not none %}
<!ENTITY RSRV_WGRIB2    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_WGRIB2;</queue><partition>{{ partition_wgrib2 }}</partition><native>&RRFS_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_WGRIB2    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_WGRIB2;</queue>">
{%- endif %}
{%- if partition_graphics is not none %}
<!ENTITY RSRV_GRAPHICS   "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_GRAPHICS;</queue><partition>{{ partition_graphics }}</partition><native>&RRFS_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_GRAPHICS   "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_GRAPHICS;</queue><native>--exclusive</native>">
{%- endif %}

{%- if do_retro %}
<!ENTITY DEADLINE_PRE      "999:00:00">
<!ENTITY DEADLINE_ANAL     "999:00:00">
<!ENTITY DEADLINE_FCST     "999:30:00">
<!ENTITY DEADLINE_POST     "999:00:00">
<!ENTITY DEADLINE_GRAPHICS "999:00:00">
{% else %}
<!ENTITY DEADLINE_PRE      "16:00:00">
<!ENTITY DEADLINE_ANAL     "16:00:00">
<!ENTITY DEADLINE_FCST     "23:30:00">
<!ENTITY DEADLINE_POST     "24:00:00">
<!ENTITY DEADLINE_GRAPHICS "24:00:00">
{% endif %}

<!ENTITY START_TIME_SPINUP "01:10:00">
<!ENTITY START_TIME_PROD "02:20:00">
<!ENTITY START_TIME_CONVENTIONAL_SPINUP "00:40:00">
<!ENTITY START_TIME_LATE_ANALYSIS "01:40:00">
<!ENTITY START_TIME_CONVENTIONAL "00:40:00">
<!ENTITY START_TIME_NSSLMOSIAC   "00:45:00">
<!ENTITY START_TIME_LIGHTNINGNC  "00:45:00">

{%- if do_retro %}
<!ENTITY WALL_LIMIT_PRE ''>
<!ENTITY WALL_LIMIT_ANAL ''>
<!ENTITY WALL_LIMIT_FCST ''>
<!ENTITY WALL_LIMIT_POST ''>
<!ENTITY WALL_LIMIT_BUFR ''>
<!ENTITY WALL_LIMIT_GRAPHICS ''>
{% else %}
<!ENTITY WALL_LIMIT_PRE '<deadline><cyclestr offset="&DEADLINE_PRE;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_ANAL '<deadline><cyclestr offset="&DEADLINE_ANAL;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_FCST '<deadline><cyclestr offset="&DEADLINE_FCST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_POST '<deadline><cyclestr offset="&DEADLINE_POST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_BUFR '<deadline><cyclestr offset="&DEADLINE_POST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_GRAPHICS '<deadline><cyclestr offset="&DEADLINE_GRAPHICS;">@Y@m@d@H@M</cyclestr></deadline>'>
{% endif %}


]>

{%- if do_retro %}
<workflow realtime="F" scheduler="&SCHED;" cyclethrottle="5" cyclelifespan="01:00:00:00">
{% else %}
<workflow realtime="T" scheduler="&SCHED;" cyclethrottle="24" cyclelifespan="01:00:00:00">
{%- endif %}
{# Double quotes are required inside the strftime! Expect an error from reading the template if using single quotes. #}
  <cycledef group="at_start">{{ at_start_cycledef }} </cycledef>

  <cycledef group="initial"> {{ initial_cycledef }} </cycledef>
  <cycledef group="boundary"> {{ boundary_cycledef }} </cycledef>
  <cycledef group="boundary_long"> {{ boundary_long_cycledef }} </cycledef>

  <cycledef group="spinupcyc"> {{ spinup_cycledef }} </cycledef>
  <cycledef group="prodcyc"> {{ prod_cycledef }} </cycledef>

  <cycledef group="postproc_normal"> {{ prod_cycledef }} </cycledef>
  <cycledef group="postproc_long"> {{ postproc_long_cycledef }} </cycledef>
  <cycledef group="archive">  {{ archive_cycledef }} </cycledef> 

  <log>
    <cyclestr>&LOGDIR;/FV3LAM_wflow.log</cyclestr>
  </log>

<!-- 
The following command works to call the J-job for a given task (in this
case the MAKE_GRID_TN task) if in the script LOAD_MODULES_RUN_TASK_FP we 
do NOT call exec to run the J-job.  The command first sources the script
LOAD_MODULES_RUN_TASK_FP and then runs the J-job, so it is simpler than
calling exec and thus preferred if NCO accepts it.  Note that the portion
of the command that sources LOAD_MODULES_RUN_TASK_FP also passes an 
argument to it (the argument being the name of the task).  This works in
bash but it probably won't work in sh.

If this method is acceptable to NCO, then for clarity maybe we can
source LOAD_MODULES_RUN_TASK_FP within the J-job instead of here since
we are already sourcing other files in the J-job anyway.
-->
<!--
    <command>{ . &LOAD_MODULES_RUN_TASK_FP; "&MAKE_GRID_TN;";
               &JOBSDIR;/JREGIONAL_MAKE_GRID;
             }</command>
-->
<!--
The following command works if we call exec in LOAD_MODULES_RUN_TASK_FP
to run the J-job.  This passes the J-job script as the second argument
to LOAD_MODULES_RUN_TASK_FP (the first argument is the task name).  The
J-job then uses exec to run the J-job (while also terminating the LOAD_-
MODULES_RUN_TASK_FP script.
-->

{% if run_task_make_grid %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_GRID_TN;" cycledefs="at_start" maxtries="{{ maxtries_make_grid }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_GRID_TN;" "&JOBSDIR;/JREGIONAL_MAKE_GRID"</command>
  {% if machine in ["WCOSS_DELL_P3", "WCOSS_CRAY"]  %}
    <nodes>{{ nnodes_make_grid }}:ppn=1</nodes>
  {% else %}
    <nodes>{{ nnodes_make_grid }}:ppn={{ ppn_make_grid }}</nodes>
  {% endif %}
    <walltime>{{ wtime_make_grid }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TAG;_&MAKE_GRID_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_GRID_TN;.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>

  </task>
{% endif %}

{% if run_task_make_orog %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_OROG_TN;" cycledefs="at_start" maxtries="{{ maxtries_make_orog }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_OROG_TN;" "&JOBSDIR;/JREGIONAL_MAKE_OROG"</command>
  {% if machine in ["WCOSS_DELL_P3", "WCOSS_CRAY"]  %}
    <nodes>{{ nnodes_make_orog }}:ppn=1</nodes>
  {% else %}
    <nodes>{{ nnodes_make_orog }}:ppn={{ ppn_make_orog }}</nodes>
  {% endif %}
    <walltime>{{ wtime_make_orog }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TAG;_&MAKE_OROG_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_OROG_TN;.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>

    <dependency>
      <or>
<!--        <taskdep task="make_grid"/> -->
        <datadep age="00:00:00:05">&LOGDIR;/&MAKE_GRID_TN;_task_complete.txt</datadep>
        <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
      </or>
    </dependency>

  </task>
{% endif %}

{% if run_task_make_sfc_climo %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_SFC_CLIMO_TN;" cycledefs="at_start" maxtries="{{ maxtries_make_sfc_climo }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_SFC_CLIMO_TN;" "&JOBSDIR;/JREGIONAL_MAKE_SFC_CLIMO"</command>
    <nodes>{{ nnodes_make_sfc_climo }}:ppn={{ ppn_make_sfc_climo }}</nodes>
    <walltime>{{ wtime_make_sfc_climo }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TAG;_&MAKE_SFC_CLIMO_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_SFC_CLIMO_TN;.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>

    <dependency>
      <and>
        <or>
<!--          <taskdep task="&MAKE_GRID_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_GRID_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_OROG_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_OROG_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
{% endif %}

{% if not is_rtma %}
{%- if do_ensemble %}
 <metatask name="run_ensemble">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}{{- fmtstr%m -}}{%- endfor %} </var>
  {%- if do_enscontrol %}
    <var name="subdirGE">/gec00{% for m in range(2, num_ens_members+1) %}{{ " /gep%02d"%m }}{% endfor %}</var>
    <var name="memNameWRF">_mem0000{% for m in range(2, num_ens_members+1) %}{{ " _mem%04d"%m }}{% endfor %} </var>
  {%- else %}
    <var name="subdirGE">{% for m in range(1, num_ens_members+1) %}{{ " /gep%02d"%m }}{% endfor %}</var>
    <var name="memNameWRF">{% for m in range(1, num_ens_members+1) %}{{ " _mem%04d"%m }}{% endfor %} </var>
    <var name="memNameGDAS">{% for m in range(1, num_ens_members+1) %}{{ " mem%03d"%m }}{% endfor %} </var>
  {%- endif %}
    <var name="subdirGDAS">{% for m in range(1, num_ens_members+1) %}{{ " /mem%03d"%m }}{% endfor %}</var>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
  <task name="&GET_EXTRN_ICS_TN;{{ uscore_ensmem_name }}" cycledefs="initial" maxtries="{{ maxtries_get_extrn_ics }}">

    &WALL_LIMIT_PRE;
    &RSRV_DEFAULT;
  {% if machine in ["WCOSS_CRAY"] %}
    <shared/>
  {% endif %}
    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_EXTRN_ICS_TN;" "&JOBSDIR;/JREGIONAL_GET_EXTRN_MDL_FILES"</command>
  {% if machine in ["WCOSS_DELL_P3"] %}
    <memory>2048M</memory><native>-R affinity[core]</native>
  {% endif %}
    <nodes>{{ nnodes_get_extrn_ics }}:ppn={{ ppn_get_extrn_ics }}</nodes>
    <walltime>{{ wtime_get_extrn_ics }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TAG;_&GET_EXTRN_ICS_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&GET_EXTRN_ICS_TN;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>EXTRN_MDL_NAME</name><value>{{ extrn_mdl_name_ics }}</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>ICS</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value>{{ slash_ensmem_subdir }}</value></envar>
    <envar><name>GEFS_INPUT_SUBDIR</name><value>#subdirGE#</value></envar>
    <envar><name>WRF_MEM_NAME</name><value>#memNameWRF#</value></envar>
    <envar><name>GDASENKF_INPUT_SUBDIR</name><value>#subdirGDAS#</value></envar>
    <envar><name>GDAS_MEM_NAME</name><value>#memNameGDAS#</value></envar>

    <dependency>
      {%- if machine in ["WCOSS_DELL_P3", "WCOSS_CRAY"]  %}
      {%- if fv3gfs_file_fmt_ics in ["netcdf"] %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.atmf{{ "%03d" % extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
      {% else %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.pgrb2.0p25.f{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
      {%- endif %}
      {%- elif machine in ["ORION"]  %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gdas.@Y@m@d/@H/atmos/gdas.t@Hz.atmf{{ "%03d" % extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
      {% else %}
      {%- if extrn_mdl_name_ics in ["GEFS"] %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/#subdirGE#/@y@j@H00000{{ extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
      {%- elif extrn_mdl_name_ics in ["GDASENKF"] %}
      <and>
      {%- if machine in ["HERA"] %}
        <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.atmf00{{ extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
        <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.sfcf00{{ extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
      {%- elif machine in ["JET"] %}
        <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H00.gdas.t@Hz.atmf00{{ extrn_mdl_ics_offset_hrs }}.#memNameGDAS#.nc</cyclestr></datadep>
        <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H00.gdas.t@Hz.sfcf00{{ extrn_mdl_ics_offset_hrs }}.#memNameGDAS#.nc</cyclestr></datadep>
      {%- endif %}
      </and>
      {%- elif extrn_mdl_name_ics in ["HRRRDAS"] %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@Y@m@d@H/postprd#memNameWRF#/wrfnat#memNameWRF#_00.grib2</cyclestr></datadep>
      {%- else %}
      {%- if machine in ["JET"] %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
      {%- elif machine in ["HERA"] %}
      <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
      {%- endif %}
      {%- endif %}
      {%- endif %}
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&GET_EXTRN_LBCS_TN;{{ uscore_ensmem_name }}" cycledefs="boundary" maxtries="{{ maxtries_get_extrn_lbcs }}">

    &WALL_LIMIT_PRE;
    &RSRV_DEFAULT;
  {% if machine in ["WCOSS_CRAY"] %}
    <shared/>
  {% endif %}
    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_EXTRN_LBCS_TN;" "&JOBSDIR;/JREGIONAL_GET_EXTRN_MDL_FILES"</command>
  {% if machine in ["WCOSS_DELL_P3"] %}
    <memory>2048M</memory><native>-R affinity[core]</native>
  {% endif %}
    <nodes>{{ nnodes_get_extrn_lbcs }}:ppn={{ ppn_get_extrn_lbcs }}</nodes>
    <walltime>{{ wtime_get_extrn_lbcs }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TAG;_&GET_EXTRN_LBCS_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&GET_EXTRN_LBCS_TN;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>EXTRN_MDL_NAME</name><value>{{ extrn_mdl_name_lbcs }}</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>LBCS</value></envar>
    <envar><name>BOUNDARY_LEN</name><value>{{ boundary_len_hrs }}</value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value>{{ slash_ensmem_subdir }}</value></envar>
    <envar><name>GEFS_INPUT_SUBDIR</name><value>#subdirGE#</value></envar>
    <envar><name>GDASENKF_INPUT_SUBDIR</name><value>#subdirGDAS#</value></envar>
    <envar><name>GDAS_MEM_NAME</name><value>#memNameGDAS#</value></envar>

    <dependency>
       <and>
         {%- for h in range(extrn_mdl_lbcs_offset_hrs, boundary_len_hrs+extrn_mdl_lbcs_offset_hrs+1, bc_update_interval) %}
         {%- if machine in ["WCOSS_DELL_P3", "WCOSS_CRAY"]  %}
         {%- if fv3gfs_file_fmt_lbcs in ["netcdf"]  %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.atmf{{ "%03d" % h }}.nc</cyclestr></datadep>
         {%- else %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.pgrb2.0p25.f{{ "%03d" % h }}</cyclestr></datadep>
         {%- endif %}
         {%- elif machine in ["ORION"]  %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gdas.@Y@m@d/@H/atmos/gdas.t@Hz.atmf{{ "%03d" % h }}.nc</cyclestr></datadep>
         {%- else %}
         {%- if extrn_mdl_name_lbcs in ["GEFS"] %}
         <datadep age="00:00:05:00"> <cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/#subdirGE#/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
         {%- elif extrn_mdl_name_lbcs in ["GDASENKF"] %}
         {%- if machine in ["HERA"] %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.atmf{{ "%03d" % h }}.nc</cyclestr></datadep>
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.sfcf{{ "%03d" % h }}.nc</cyclestr></datadep>
         {%- elif machine in ["JET"] %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H00.gdas.t@Hz.atmf{{ "%03d" % h }}.#memNameGDAS#.nc</cyclestr></datadep>
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H00.gdas.t@Hz.sfcf{{ "%03d" % h }}.#memNameGDAS#.nc</cyclestr></datadep>
         {%- endif %}
         {%- else %}
         {%- if machine in ["JET"] %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
         {%- elif machine in ["HERA"] %}
         <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
         {%- endif %}
         {%- endif %}
         {%- endif %}
         {%- endfor %}
       </and>
    </dependency>

  </task>

{%- if do_ensemble %}
   </metatask>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&GET_EXTRN_LBCS_LONG_TN;" cycledefs="boundary_long" maxtries="{{ maxtries_get_extrn_lbcs }}">

    &WALL_LIMIT_PRE;
    &RSRV_DEFAULT;
  {% if machine in ["WCOSS_CRAY"] %}
    <shared/>
  {% endif %}
    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_EXTRN_LBCS_TN;" "&JOBSDIR;/JREGIONAL_GET_EXTRN_MDL_FILES"</command>
  {% if machine in ["WCOSS_DELL_P3"] %}
    <memory>2048M</memory><native>-R affinity[core]</native>
  {% endif %}
    <nodes>{{ nnodes_get_extrn_lbcs }}:ppn={{ ppn_get_extrn_lbcs }}</nodes>
    <walltime>{{ wtime_get_extrn_lbcs }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TAG;_&GET_EXTRN_LBCS_LONG_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&GET_EXTRN_LBCS_LONG_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>EXTRN_MDL_NAME</name><value>{{ extrn_mdl_name_lbcs }}</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>LBCS</value></envar>
    <envar><name>BOUNDARY_LEN</name><value>{{ boundary_long_len_hrs }}</value></envar>

    <dependency>
       <and>
         {%- for h in range(extrn_mdl_lbcs_offset_hrs, boundary_long_len_hrs+extrn_mdl_lbcs_offset_hrs+1, bc_update_interval) %}
         {%- if machine in ["WCOSS_DELL_P3", "WCOSS_CRAY"]  %}
         <datadep age="00:00:05:00"><cyclestr>{{ extrn_mdl_sysbasedir_ics }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.pgrb2.0p25.f{{ "%03d" % h }}</cyclestr></datadep>
         {%- elif machine in ["ORION"]  %}
         <datadep age="00:00:05:00"><cyclestr>{{ extrn_mdl_sysbasedir_ics }}/gdas.@Y@m@d/@H/atmos/gdas.t@Hz.atmf{{ "%03d" % h }}.nc</cyclestr></datadep>
         {%- else %}
         <datadep age="00:00:05:00"> <cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
         {%- endif %}
         {%- endfor %}
       </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
 {%- if do_ensemble %}
 <metatask name="run_ensemble">
   <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}
    {%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}
    {{- fmtstr%m -}}
   {%- endfor %} </var>
 {%- endif %}

  <task name="&MAKE_ICS_TN;{{ uscore_ensmem_name }}" cycledefs="initial" maxtries="{{ maxtries_make_ics }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_ICS_TN;" "&JOBSDIR;/JREGIONAL_MAKE_ICS"</command>
    <nodes>{{ nnodes_make_ics }}:ppn={{ ppn_make_ics }}</nodes>
    <walltime>{{ wtime_make_ics }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TAG;_&MAKE_ICS_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_ICS_TN;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&GET_EXTRN_ICS_TN;{{ uscore_ensmem_name }}"/>
        <or>
<!--          <taskdep task="&MAKE_GRID_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_GRID_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_OROG_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_OROG_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_SFC_CLIMO_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_SFC_CLIMO_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}" cycledefs="boundary,boundary_long" maxtries="{{ maxtries_make_lbcs }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_LBCS_TN;" "&JOBSDIR;/JREGIONAL_MAKE_LBCS"</command>
    <nodes>{{ nnodes_make_lbcs }}:ppn={{ ppn_make_lbcs }}</nodes>
    <walltime>{{ wtime_make_lbcs }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&TAG;_&MAKE_LBCS_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_LBCS_TN;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <and>
        <or>
          <taskdep task="&GET_EXTRN_LBCS_TN;{{ uscore_ensmem_name }}"/>
          <taskdep task="&GET_EXTRN_LBCS_LONG_TN;"/>
        </or>
        <or>
<!--          <taskdep task="&MAKE_GRID_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_GRID_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_OROG_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_OROG_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_SFC_CLIMO_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_SFC_CLIMO_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>

{%- endif %}

{%- if do_spinup %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&PREP_CYC_SPINUP_TN;" cycledefs="spinupcyc" maxtries="{{ maxtries_run_prepstart }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_PREPSTART_TN;" "&JOBSDIR;/JREGIONAL_RUN_PREPSTART"</command>

    <nodes>{{ nnodes_run_prepstart }}:ppn={{ ppn_run_prepstart }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <walltime>{{ wtime_run_prepstart }}</walltime>
    <jobname>&TAG;_&PREP_CYC_SPINUP_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&PREP_CYC_SPINUP_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>FG_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>LBCS_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
       <or>
<!-- for start spin up cycle -->
         <and>
           <or>
             {%- for h in cycl_hrs_spinstart %}
             <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
           </or>
{%- if do_retro %}
           <datadep age="00:00:05:00"><cyclestr>&FG_ROOT;/@Y@m@d@H/ics/gfs_data.tile7.halo0.nc</cyclestr></datadep>
           <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">&FG_ROOT;/@Y@m@d@H/lbcs/gfs_bndy.tile7.001.nc</cyclestr></datadep>
           <datadep age="00:00:10:00"><cyclestr offset="00:00:00">&FG_ROOT;/@Y@m@d@H/fcst_fv3lam/INPUT/gfs_ctrl.nc</cyclestr></datadep>
{% else %}
           <and>
             <timedep><cyclestr offset="&START_TIME_SPINUP;">@Y@m@d@H@M00</cyclestr></timedep>
             <taskdep task="&MAKE_ICS_TN;"/>
             <taskdep task="&MAKE_LBCS_TN;" cycle_offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00"/>
           </and>
{%- endif %}
         </and>
<!-- for continue spin up cycles  -->
         <and>
           {%- for h in cycl_hrs_spinstart %}
           <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
           {%- endfor %}
{%- if do_retro %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/@Y@m@d@H/fcst_fv3lam_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
{% else %}
           <timedep><cyclestr offset="&START_TIME_CONVENTIONAL_SPINUP;">@Y@m@d@H@M00</cyclestr></timedep>
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/@Y@m@d@H/fcst_fv3lam_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
{%- endif %}
         </and>
       </or>
    </dependency>

  </task>

{%- endif %}
<!--
************************************************************************
************************************************************************
-->

  <task name="&PREP_CYC_PROD_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_run_prepstart }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_PREPSTART_TN;" "&JOBSDIR;/JREGIONAL_RUN_PREPSTART"</command>
    <nodes>{{ nnodes_run_prepstart }}:ppn={{ ppn_run_prepstart }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <walltime>{{ wtime_run_prepstart }}</walltime>
    <jobname>&TAG;_&PREP_CYC_PROD_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&PREP_CYC_PROD_TN;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>FG_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>LBCS_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
       <or>
<!-- for start product cycle -->
         <and>
           <or>
             {%- for h in cycl_hrs_prodstart %}
             <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
           </or>
{%- if do_spinup %}
{%- if do_retro %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
{% else %}
           <or>
             <and>
               <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
               <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             </and>
             <and>
               <timedep><cyclestr offset="&START_TIME_PROD;">@Y@m@d@H@M00</cyclestr></timedep>
               <or>
                 {%- for h in range(da_cycle_interval_hrs, 6+1, da_cycle_interval_hrs) %}
                 <datadep age="00:00:01:00"><cyclestr offset="-{{ h }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
                 {%- endfor %}
               </or>
             </and>
           </or>
{%- endif %}
{% else %}
{%- if do_retro %}
           <and>
             <datadep age="00:00:05:00"><cyclestr>&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/ics/gfs_data.tile7.halo0.nc</cyclestr></datadep>
             <or>
             {%- for h in range(0, extrn_mdl_ics_offset_hrs+1) %}
             <datadep age="00:00:05:00"><cyclestr offset="-{{ h }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/lbcs/gfs_bndy.tile7.{{ "%03d" % boundary_len_hrs }}.nc</cyclestr></datadep>
             {%- endfor %}
             </or>
           </and>
{% else %}
           <and>
             <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
             <taskdep task="&MAKE_ICS_TN;{{ uscore_ensmem_name }}"/>
             <taskdep task="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}" cycle_offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00"/>
           </and>
{%- endif %}
{%- endif %}
         </and>
<!-- for continue product cycles  -->
         <and>
           {%- for h in cycl_hrs_prodstart %}
           <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
           {%- endfor %}
{%- if do_retro %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
{% else %}
           <or>
             <and>
               <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
               <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             </and>
             <and>
               <timedep><cyclestr offset="&START_TIME_LATE_ANALYSIS;">@Y@m@d@H@M00</cyclestr></timedep>
               <or>
                 {%- for h in range(da_cycle_interval_hrs+da_cycle_interval_hrs, 6+1, da_cycle_interval_hrs) %}
                 <datadep age="00:00:01:00"><cyclestr offset="-{{ h }}:00:00">&FG_ROOT;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
                 {%- endfor %}
               </or>
             </and>
           </or>
{%- endif %}
         </and>
       </or>
    </dependency>

  </task>

<!-- beginning of meta block for prod spinup  -->
<metatask name="do_prod_and_spinup_cyc">
  
{%- if do_spinup %}
  <var name="type">prod spinup</var>
{% else %}
  <var name="type">prod</var>
{%- endif %}


{%- if do_nonvar_cldanal or do_refl2tten %}
<!--
************************************************************************
************************************************************************
--> 
  <task name="&PROCESS_RADAR_REF_TN;_#type#" cycledefs="#type#cyc"  maxtries="{{ maxtries_process_radarref }}">
    
    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSDIR;/JREGIONAL_PROCESS_RADARREF"</command>
      
    <nodes>{{ nnodes_proc_radar }}:ppn={{ ppn_proc_radar }};</nodes>
    <walltime>{{ wtime_proc_radar }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&PROCESS_RADAR_REF_TN;_#type#</jobname>
    <join><cyclestr>&LOGDIR;/&PROCESS_RADAR_REF_TN;_#type#_@Y@m@d@H.log</cyclestr></join>
        
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>
        
    <dependency>
      <and>
        <timedep><cyclestr offset="&START_TIME_NSSLMOSIAC;">@Y@m@d@H@M00</cyclestr></timedep>
      </and>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->
{%- if do_nldn_lght %}
  <task name="&PROCESS_LIGHTNING_TN;_#type#" cycledefs="#type#cyc"  maxtries="{{ maxtries_process_lightning }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSDIR;/JREGIONAL_PROCESS_LIGHTNING"</command>

    <nodes>{{ nnodes_proc_lightning }}:ppn={{ ppn_proc_lightning }};</nodes>
    <walltime>{{ wtime_proc_lightning }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&PROCESS_LIGHTNING_TN;_#type#</jobname>
    <join><cyclestr>&LOGDIR;/&PROCESS_LIGHTNING_TN;_#type#_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>

    <dependency>
      <and>
        <timedep><cyclestr offset="&START_TIME_LIGHTNINGNC;">@Y@m@d@H@M00</cyclestr></timedep>
      </and>
    </dependency>

  </task>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
  <task name="&PROCESS_BUFR_TN;_#type#" cycledefs="#type#cyc"  maxtries="{{ maxtries_process_bufr }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSDIR;/JREGIONAL_PROCESS_BUFR"</command>

    <nodes>{{ nnodes_proc_bufr }}:ppn={{ ppn_proc_bufr }};</nodes>
    <walltime>{{ wtime_proc_bufr }}</walltime>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <memory>{{ memo_run_processbufr }}</memory>
    <jobname>&PROCESS_BUFR_TN;_#type#</jobname>
    <join><cyclestr>&LOGDIR;/&PROCESS_BUFR_TN;_#type#_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>

    <dependency>
      <and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </and>
    </dependency>

  </task>

{%- endif %}

{%- if do_dacycle %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ANAL_GSI_TN;_#type#{{ uscore_ensmem_name }}" cycledefs="#type#cyc" maxtries="{{ maxtries_anal_gsi }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSDIR;/JREGIONAL_RUN_ANAL"</command>
    {% if machine in ["JET", "HERA"] -%}
    <cores>{{ ncores_run_anal }}</cores>
    <native>{{ native_run_anal }} &RRFS_RESERVE;</native>
    {% else -%}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    {% endif -%}
    <walltime>{{ wtime_run_anal }}</walltime>
    <jobname>&TAG;_&ANAL_GSI_TN;_#type#{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&ANAL_GSI_TN;{{ uscore_ensmem_name }}_#type#_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&CYCLE_BASEDIR;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&NWGES_BASEDIR;/satbias</cyclestr></value></envar>

    <dependency>
       <and>
         <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
         <taskdep task="&PREP_CYC_TN;_#type#{{ uscore_ensmem_name }}"/>
       </and>
    </dependency>

  </task>
{% endif -%}

{%- if do_refl2tten %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&RADAR_REFL2TTEN_TN;_#type#" cycledefs="#type#cyc"  maxtries="{{ maxtries_radar_ref2tten }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSDIR;/JREGIONAL_REFL2TTEN"</command>
    <nodes>{{ nnodes_run_ref2tten }}:ppn={{ ppn_run_ref2tten }}</nodes>
    <walltime>{{ wtime_run_ref2tten }}</walltime>
    <memory>{{ memo_run_ref2tten }}</memory>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&RADAR_REFL2TTEN_TN;_#type#</jobname>
    <join><cyclestr>&LOGDIR;/&RADAR_REFL2TTEN_TN;_#type#_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <and>
        <or>
          <taskdep task="&PROCESS_RADAR_REF_TN;_#type#"/>
          <taskdep task="&PROCESS_BUFR_TN;_#type#"/>
        </or>
        <taskdep task="&ANAL_GSI_TN;_#type#"/>
      </and>
    </dependency>

  </task>

{%- endif %}

{%- if do_nonvar_cldanal %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&CLDANL_NONVAR_TN;_#type#{{ uscore_ensmem_name }}" cycledefs="#type#cyc"  maxtries="{{ maxtries_cldanl_nonvar }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSDIR;/JREGIONAL_NONVARCLD"</command>
    <nodes>{{ nnodes_run_nonvarcldanl }}:ppn={{ ppn_run_nonvarcldanl }}</nodes>
    <walltime>{{ wtime_run_nonvarcldanl }}</walltime>
    <memory>{{ memo_run_nonvarcldanl }}</memory>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <jobname>&CLDANL_NONVAR_TN;_#type#</jobname>
    <join><cyclestr>&LOGDIR;/&CLDANL_NONVAR_TN;_#type#_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&PROCESS_BUFR_TN;_#type#"/>
        {%- if do_enkfupdate %}
        <and>
           {%- for h in cycl_hrs_prodstart %}
            <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
           {%- endfor %}
           <metataskdep metatask="run_enkf_post"/>
        </and>
        {%- else %}
        <taskdep task="&ANAL_GSI_TN;_#type#"/>
        {%- endif %}
      </and>
    </dependency>

  </task>

{%- endif %}

<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_FCST_TN;_#type#{{ uscore_ensmem_name }}" cycledefs="#type#cyc" maxtries="{{ maxtries_run_fcst }}">

    &RSRV_FCST;
    &WALL_LIMIT_FCST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_FCST_TN;" "&JOBSDIR;/JREGIONAL_RUN_FCST"</command>
  {% if machine in ["JET", "HERA"]  %}
    <cores>{{ ncores_run_fcst }}</cores>
    <native>{{ native_run_fcst }} &RRFS_RESERVE;</native>
  {% else %}
    <nodes>{{ nnodes_run_fcst }}:ppn={{ ppn_run_fcst }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
  {% endif %}
    <walltime>{{ wtime_run_fcst }}</walltime>
    <jobname>&TAG;_&RUN_FCST_TN;_#type#{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&RUN_FCST_TN;_#type#{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>
  
    <dependency>
      {%- if do_dacycle and do_refl2tten%}
      <taskdep task="&RADAR_REFL2TTEN_TN;_#type#"/>
      {%- elif do_dacycle and do_nonvar_cldanal%}
      <taskdep task="&CLDANL_NONVAR_TN;_#type#"/>
      {%- elif do_dacycle %}
      <taskdep task="&ANAL_GSI_TN;_#type#{{ uscore_ensmem_name }}"/>
      {%- elif do_enkfupdate %}
      <or>
        <and>
          <or>
           {%- for h in cycl_hrs_prodstart %}
            <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
           {%- endfor %}
          </or>
          <taskdep task="&PREP_CYC_TN;_#type#{{ uscore_ensmem_name }}"/>
        </and>
        {%- if do_nonvar_cldanal%}
        <taskdep task="&CLDANL_NONVAR_TN;_#type#{{ uscore_ensmem_name }}"/>
        {%- else %}
        <taskdep task="&RUN_ENKFUPDT_TN;"/>
        {%- endif %}
      </or>
      {%- else %}
      <taskdep task="&PREP_CYC_TN;_#type#{{ uscore_ensmem_name }}"/>
      {%- endif %}
    </dependency>

  </task>

<!-- end of meta block for prod spinup  -->
</metatask>

<!--
************************************************************************
************************************************************************
-->

  <metatask name="&RUN_POST_TN;{{ uscore_ensmem_name }}">

    <var name="fhr"> {% for h in range(0, postproc_long_len_hrs+1) %}{{ " %03d" % h  }}{% endfor %} </var>
    <var name="type"> {% for h in range(0, postproc_len_hrs+1) %}{{ " normal" }}{% endfor %} {% for h in range(postproc_len_hrs+1, postproc_long_len_hrs+1) %}{{ " long"  }}{% endfor %} </var>

    <task name="&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="postproc_#type#" maxtries="{{ maxtries_run_post }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_POST;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSDIR;/JREGIONAL_RUN_POST"</command>
      <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
      <walltime>{{ wtime_run_post }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <jobname>&TAG;_&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>TMMARK</name><value>tm00</value></envar>

      <dependency>
        <datadep age="01:30"><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H{{ slash_ensmem_subdir }}/fcst_fv3lam/logf#fhr#</cyclestr></datadep>
      </dependency>

    </task>

    <task name="&RUN_WGRIB2_TN;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="postproc_#type#" maxtries="{{ maxtries_run_wgrib2 }}">

      &RSRV_WGRIB2;
      &WALL_LIMIT_POST;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_WGRIB2_TN;" "&JOBSDIR;/JREGIONAL_RUN_WGRIB2"</command>
      <nodes>{{ nnodes_run_wgrib2 }}:ppn={{ ppn_run_wgrib2 }}</nodes>
      <walltime>{{ wtime_run_wgrib2 }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <memory>{{ memo_run_wgrib2 }}</memory>
      <jobname>&TAG;_&RUN_WGRIB2_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&RUN_WGRIB2_TN;{{ uscore_ensmem_name }}_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>TMMARK</name><value>tm00</value></envar>

      <dependency>
        <taskdep task="&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#"/>
      </dependency>

    </task>

  </metatask>

{%- if machine in ["JET", "HERA"]  %}
<!--
************************************************************************
************************************************************************
-->

  <metatask name="python_maps">

    <var name="tilelabel"> {{ tilelabels }} </var>
    <var name="tileset"> {{ tilesets }} </var>
    <task name="python_maps{{ uscore_ensmem_name }}_#tilelabel#" cycledefs="prodcyc" maxtries="{{ maxtries_run_post }}">

      &RSRV_GRAPHICS;
      &WALL_LIMIT_GRAPHICS;

      <walltime>{{ wtime_run_fcst }}</walltime>
      <nodes>{{ nnodes_run_graphics }}:ppn={{ ppn_run_graphics }}</nodes>
      <jobname><cyclestr>&TAG;_python{{ uscore_ensmem_name }}_@H_#tilelabel#</cyclestr></jobname>
      <join><cyclestr>&LOGDIR;/python{{ uscore_ensmem_name }}_#tilelabel#.log</cyclestr></join>
      <command>&LOAD_MODULES_RUN_TASK_FP; "run_graphics" "&JOBSDIR;/JREGIONAL_RUN_PYTHON_GRAPHICS"</command>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
      <envar><name>GRAPHICS_TYPE</name><value>maps</value></envar>
      <envar><name>TILES</name><value>#tileset#</value></envar>
      <envar><name>TILELABEL</name><value>#tilelabel#</value></envar>

      <dependency>
        <taskdep task="&RUN_WGRIB2_TN;{{ uscore_ensmem_name }}_f000"/>
      </dependency>
    </task>
  </metatask>

  <task name="python_skewts{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_run_post }}">

    &RSRV_GRAPHICS;
    &WALL_LIMIT_GRAPHICS;

    <walltime>{{ wtime_run_fcst }}</walltime>
    <nodes>{{ nnodes_run_graphics }}:ppn={{ ppn_run_graphics }}</nodes>
    <jobname><cyclestr>&TAG;_python{{ uscore_ensmem_name }}_@H_skewts</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/python_skewts{{ uscore_ensmem_name }}_@H.log</cyclestr></join>
    <command>&LOAD_MODULES_RUN_TASK_FP; "run_graphics" "&JOBSDIR;/JREGIONAL_RUN_PYTHON_GRAPHICS"</command>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>GRAPHICS_TYPE</name><value>skewts</value></envar>

    <dependency>
      <taskdep task="&RUN_WGRIB2_TN;{{ uscore_ensmem_name }}_f000"/>
    </dependency>
  </task>

{%- endif %}

{%- if do_spinup %}
<!--
************************************************************************
************************************************************************
-->
  <metatask name="&RUN_POST_TN;_spinup">

    <var name="fhr"> {% for h in range(0, fcst_len_hrs_spinup+1) %}{{ " %03d" % h  }}{% endfor %} </var>

    <task name="&RUN_POST_TN;_spinup_f#fhr#" cycledefs="spinupcyc" maxtries="{{ maxtries_run_post }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_POST;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSDIR;/JREGIONAL_RUN_POST"</command>
      <nodes>{{ nnodes_run_post }}:ppn={{ ppn_run_post }}</nodes>
      <walltime>{{ wtime_run_post }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <jobname>&TAG;_&RUN_POST_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&RUN_POST_TN;_spinup_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr></cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
      <envar><name>TMMARK</name><value>tm00</value></envar>

      <dependency>
        <datadep age="02:30"><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H/fcst_fv3lam_spinup/logf#fhr#</cyclestr></datadep>
      </dependency>

    </task>

    <task name="&RUN_WGRIB2_TN;_spinup_f#fhr#" cycledefs="spinupcyc" maxtries="{{ maxtries_run_wgrib2 }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_POST;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_WGRIB2_TN;" "&JOBSDIR;/JREGIONAL_RUN_WGRIB2"</command>
      <nodes>{{ nnodes_run_wgrib2 }}:ppn={{ ppn_run_wgrib2 }}</nodes>
      <walltime>{{ wtime_run_wgrib2 }}</walltime>
      <nodesize>&NCORES_PER_NODE;</nodesize>
      <memory>{{ memo_run_wgrib2 }}</memory>
      <jobname>&TAG;_&RUN_WGRIB2_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&RUN_WGRIB2_TN;_spinup_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr></cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
      <envar><name>TMMARK</name><value>tm00</value></envar>

      <dependency>
        <taskdep task="&RUN_POST_TN;_spinup_f#fhr#"/>
      </dependency>

    </task>

  </metatask>

{%- endif %}

<!--
************************************************************************
************************************************************************
-->
  <task name="&CLEAN_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_run_post }}">

    &RSRV_DEFAULT;

    <command>&JOBSDIR;/../scripts/exregional_clean.ksh</command>
    <cores>1</cores>
    <walltime>00:15:00</walltime>
    <jobname>&TAG;_&CLEAN_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&CLEAN_TN;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>NWGES_BASEDIR</name><value><cyclestr>&NWGES_BASEDIR;</cyclestr></value></envar>
      <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr></cyclestr></value></envar>

  </task>

{%- if machine in ["JET", "HERA"]  %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ARCHIVE_TN;{{ uscore_ensmem_name }}" cycledefs="archive" maxtries="{{ maxtries_run_post }}">

    &RSRV_HPSS;

    <command>&JOBSDIR;/../scripts/exregional_archive.ksh</command>
    <cores>1</cores>
    <walltime>04:00:00</walltime>
    <memory>24G</memory>
    <jobname>&TAG;_&ARCHIVE_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&ARCHIVE_TN;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>

  </task>

{%- endif %}

{%- if do_ensemble %}
  </metatask>
{%- endif %}

{%- if do_gsiobserver %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&PREP_CYC_ENSMEAN_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_run_prepstart }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_PREPSTART_TN;" "&JOBSDIR;/JREGIONAL_RUN_PREPSTART_ENSMEAN"</command>
    <nodes>{{ nnodes_run_prepstart }}:ppn={{ ppn_run_prepstart }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    <walltime>{{ wtime_run_prepstart_ensmean }}</walltime>
    <jobname>&TAG;_&PREP_CYC_ENSMEAN_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&PREP_CYC_ENSMEAN_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
<!--
    <envar><name>FG_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>LBCS_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
-->
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>NUM_ENS_MEMBERS</name><value><cyclestr>#{{ num_ens_members }}#</cyclestr></value></envar>

    <dependency>
         <and>
         {%- for h in cycl_hrs_prodstart %}
         <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
         {%- endfor %}
         {%- for m in range(1, num_ens_members+1) %}
         <taskdep task="&PREP_CYC_PROD_TN;_mem{{ "%04d" % m }}"/>
         {%- endfor %}
         </and>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->
  <task name="&OBSERVER_GSI_ENSMEAN_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_anal_gsi }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSDIR;/JREGIONAL_RUN_ANAL"</command>
    {% if machine in ["JET", "HERA"] -%}
    <cores>{{ ncores_run_observer }}</cores>
    <native>{{ native_run_anal }} &RRFS_RESERVE;</native>
    {% else -%}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    {% endif -%}
    <walltime>{{ wtime_run_anal }}</walltime>
    <jobname>&TAG;_&OBSERVER_GSI_ENSMEAN_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&OBSERVER_GSI_ENSMEAN_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&CYCLE_BASEDIR;</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>OBSERVER</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEAN</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&NWGES_BASEDIR;/satbias</cyclestr></value></envar>

    <dependency>
       <and>
         <taskdep task="&PREP_CYC_ENSMEAN_TN;"/>
         <datadep age="05:00"><cyclestr>&OBSPATH;/@Y@m@d@H.rap.t@Hz.prepbufr.tm00</cyclestr></datadep>
       </and>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->
 {%- if do_ensemble %}
 <metatask name="run_ensemble_observer">
   <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}
    {%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}
    {{- fmtstr%m -}}
   {%- endfor %} </var>
 {%- endif %}

  <task name="&OBSERVER_GSI_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_anal_gsi }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANAL;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ANAL_TN;" "&JOBSDIR;/JREGIONAL_RUN_ANAL"</command>
    {% if machine in ["JET", "HERA"] -%}
    <cores>{{ ncores_run_observer }}</cores>
    <native>{{ native_run_anal }} &RRFS_RESERVE;</native>
    {% else -%}
    <nodes>{{ nnodes_run_anal }}:ppn={{ ppn_run_anal }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    {% endif -%}
    <walltime>{{ wtime_run_anal }}</walltime>
    <jobname>&TAG;_&OBSERVER_GSI_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&OBSERVER_GSI_TN;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&CYCLE_BASEDIR;</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>OBSERVER</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SLASH_ENSMEM_SUBDIR</name><value><cyclestr>{{ slash_ensmem_subdir }}</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&NWGES_BASEDIR;/satbias</cyclestr></value></envar>

    <dependency>
       <and>
         <taskdep task="&OBSERVER_GSI_ENSMEAN_TN;"/>
       </and>
    </dependency>

  </task>

{%- if do_ensemble %}
  </metatask>
{%- endif %}

{%- endif %}

{%- if do_enkfupdate %}
<!--
************************************************************************
************************************************************************
-->

  <task name="&RUN_ENKFUPDT_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_anal_enkf }}">
    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANAL;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_ENKFUPDT_TN;" &JOBSDIR;/JREGIONAL_RUN_ENKF</command>

    {% if machine in ["JET"] -%}
    <cores>{{ ncores_run_enkf }}</cores>
    <native>{{ native_run_enkf }} &RRFS_RESERVE;</native>
    {% else -%}
    <nodes>{{ nnodes_run_enkf }}:ppn={{ ppn_run_enkf }}</nodes>
    <nodesize>&NCORES_PER_NODE;</nodesize>
    {% endif -%}
    <walltime>{{ wtime_run_enkf }}</walltime>
    <jobname><cyclestr>&TAG;_&RUN_ENKFUPDT_TN;</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/&RUN_ENKFUPDT_TN;_@Y@m@d@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&CYCLE_BASEDIR;</cyclestr></value></envar>
    <envar><name>NWGES_DIR</name><value><cyclestr>&NWGES_BASEDIR;/@Y@m@d@H</cyclestr></value></envar>

    <dependency>
        <metataskdep metatask="run_ensemble_observer"/>
    </dependency>
  </task>

{%- endif %}

</workflow>
