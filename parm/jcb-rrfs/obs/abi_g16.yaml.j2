  # Observation Space (I/O)
  # -----------------------
     - obs space:
         name: abi_g16
         _anchor_channels: &abi_g16_channels 7-16
         _anchor_use_flag: &abi_g16_use_flag [-1, 1, 1, 1, -1, -1, -1, -1, -1, -1]
         _anchor_use_flag_clddet: &abi_g16_use_flag_clddet [-2, -2, -2, -2, -2, -2, -2, -2, -2, -2]
         _anchor_error: &abi_g16_error [ 2.2, 1.756, 1.587, 1.185, 2.2, 2.2, 2.2, 2.2, 2.2, 2.2 ]
         _anchor_obserr_bound_max: &abi_g16_obserr_bound_max [2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0]
         distribution:
           name: "RoundRobin"
           halo size: 500e3
         obsdatain:
           engine:
             type: H5File
             obsfile: "data/obs/ioda_abi_g16.nc"
             missing file action: "warn"
         obsdataout:
           empty obs space action: "{{emptyObsSpaceAction}}"
           engine:
             type: H5File
             obsfile: jdiag_abi_g16.nc
         io pool:
           max pool size: 1
         simulated variables: [brightnessTemperature]
         observed variables: [brightnessTemperature]
         channels: *abi_g16_channels

  # Observation Operator
  # --------------------
       obs operator:
         name: CRTM
         Absorbers: [H2O, O3, CO2]
         #Clouds: [Water, Ice]
         #Cloud_Fraction: 1.0
         SurfaceWindGeoVars: uv
         obs options:
           Sensor_ID:  abi_g16
           EndianType: little_endian
           CoefficientPath: data/crtm/
           IRVISlandCoeff: IGBP
         linear obs operator:
           Absorbers: [H2O, O3]
       obs localizations:
         - localization method: Horizontal Gaspari-Cohn
           lengthscale: 200e3 # orig

  # Observation Bias Correction (VarBC)
  # -----------------------------------
       obs bias:
         input file: data/satbias_in/abi_g16.satbias.nc
         output file: data/satbias_out/abi_g16.satbias.nc
         variational bc:
           predictors:
           - name: constant
           - name: lapseRate
             order: 2
             tlapse: &abi_g16_tlapse data/satbias_in/abi_g16.tlapse.txt
           - name: lapseRate
             tlapse: *abi_g16_tlapse
           - name: emissivityJacobian
           - name: sensorScanAngle
             var_name: sensorScanPosition
             order: 4
           - name: sensorScanAngle
             var_name: sensorScanPosition
             order: 3
           - name: sensorScanAngle
             var_name: sensorScanPosition
             order: 2
           - name: sensorScanAngle
             var_name: sensorScanPosition
         covariance:
           minimal required obs number: 20
           variance range: [1.0e-6, 10.0]
           step size: 1.0e-4
           largest analysis variance: 10000.0
           prior:
             input file: data/satbias_in/abi_g16.satbias_cov.nc
             inflation:
               ratio: 1.1
               ratio for small dataset: 2.0
           output file: data/satbias_out/abi_g16.satbias_cov.nc

  # Observation Filters (QC)
  # ------------------------
       obs pre filters:
       # Satellite Zenith Angle Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         test variables:
         - name: MetaData/sensorZenithAngle
         maxvalue: 65.
         action:
           name: reduce obs space
       # Data Thinning
       - filter: Gaussian Thinning
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         #horizontal_mesh: 145
         horizontal_mesh: 60
         use_reduced_horizontal_grid: true
         distance_norm: maximum
         time_mesh: '{{THINNING_TIME_MESH}}'
         time_min: '{{THINNING_TIME_MIN}}'
         time_max: '{{THINNING_TIME_MAX}}'
         #  round_horizontal_bin_count_to_nearest: true
         #  partition_longitude_bins_using_mesh: true
         actions:
           - name: reduce obs space

       # from read_abi: Reject when cloud fraction is more than 30
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         where:
         - variable:
             name: MetaData/cloudAmount
             channels: 8
           maxvalue: 30.
         action:
           name: reduce obs space

       # from read_abi: WV Channels 8-10 scene consistency check SDTB>1.3
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature
             channels: 8-10
           maxvalue: 1.3
           max_exclusive: true
         action:
           name: reduce obs space


       obs prior filters:
       # Initial obs error assignment
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         action:
           name: assign error
           error parameter vector: *abi_g16_error

       # Surface flag assignment from geoval
       - filter: Variable Assignment
         assignments:
         - name: DerivedMetaData/surfaceFlag
           type: int
           function:
             name: IntObsFunction/Conditional
             options:
               defaultvalue: 4
               firstmatchingcase: true
               cases:
               - where:
                 - variable:
                     name: GeoVaLs/water_area_fraction
                   minvalue: 0.99
                 value: 0
               - where:
                 - variable:
                     name: GeoVaLs/land_area_fraction
                   minvalue: 0.99
                 value: 1
               - where:
                 - variable:
                     name: GeoVaLs/ice_area_fraction
                   minvalue: 0.99
                 value: 2
               - where:
                 - variable:
                     name: GeoVaLs/surface_snow_area_fraction
                   minvalue: 0.99
                 value: 3

       # Surface Parameter assignment from geovals
       - filter: Variable Assignment
         assignments:
         - name: DerivedMetaData/surfaceParam
           type: int
           function:
             name: IntObsFunction/Conditional
             options:
               defaultvalue: 0
               firstmatchingcase: true
               cases:
               - where:
                 - variable:
                     name: GeoVaLs/water_area_fraction
                   minvalue: 0.99
                 value: 30
               - where:
                 - variable:
                     name: GeoVaLs/land_area_fraction
                   minvalue: 0.99
                 value: 15
               - where:
                 - variable:
                     name: GeoVaLs/ice_area_fraction
                   minvalue: 0.99
                 value: 20
               - where:
                 - variable:
                     name: GeoVaLs/surface_snow_area_fraction
                   minvalue: 0.99
                 value: 15

       obs post filters:
       # Regional domain check to remove data outside of model domain
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         test variables:
         - name: GeoVaLs/observable_domain_mask
           flag all filter variables if any test variable is out of bounds: true
           minvalue: 0.0
           maxvalue: 0.5

       #Toss data if the hofx is missing or outside of range
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         where:
         - variable:
             name: HofX/brightnessTemperature
             channels: *abi_g16_channels
           value: is_valid
           minvalue: 50.00001
           maxvalue: 449.99999
         action:
           name: reject

       # Surface type check
       # Toss channels 7,11-16 over land
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: 7, 11-16
         where:
         - variable:
             name: GeoVaLs/land_area_fraction
           minvalue: 0.99

       # Toss all channels data over snow
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         where:
         - variable:
             name: GeoVaLs/surface_snow_area_fraction
           minvalue: 0.99

       # Toss all channels data over ice
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         where:
         - variable:
             name: GeoVaLs/ice_area_fraction
           minvalue: 0.99

       # Toss all channels data over mixed surface
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         where:
         - variable:
             name: GeoVaLs/land_area_fraction
           maxvalue: 0.99
           max_exclusive: true
         - variable:
             name: GeoVaLs/water_area_fraction
           maxvalue: 0.99
           max_exclusive: true
         - variable:
             name: GeoVaLs/ice_area_fraction
           maxvalue: 0.99
           max_exclusive: true
         - variable:
             name: GeoVaLs/surface_snow_area_fraction
           maxvalue: 0.99
           max_exclusive: true

       # BT range check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         minvalue: 0.0
         maxvalue: 1000.0
         action:
           name: reject

       # Model top transmittance check
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsFunction/ObsErrorFactorTransmitTopRad
             channels: *abi_g16_channels
             options:
               channels: *abi_g16_channels

       # Cloud detection
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         test variables:
         - name: ObsFunction/CloudDetectMinResidualIR
           channels: *abi_g16_channels
           options:
             channels: *abi_g16_channels
             use_flag: *abi_g16_use_flag
             use_flag_clddet: *abi_g16_use_flag_clddet
             obserr_dtempf: [0.5, 2.0, 4.0, 2.0, 4.0]
             error parameter vector: *abi_g16_error
         maxvalue: 1.0e-12
         action:
           name: reject

       # Scene Consistency Check based on ch13 (10.8 micron)
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: 7, 10-16
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature
             channels: 13
           maxvalue: 0.5
           max_exclusive: true

       # Aadjust Channels 8-10 varinv according to ch8 BT standard deviation
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           maxvalue: 0.5
           minvalue: 0.4
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.1489

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           maxvalue: 0.6
           #max_exclusive: true
           minvalue: 0.5
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.2923

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           maxvalue: 0.7
           #max_exclusive: true
           minvalue: 0.6
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.4967

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           minvalue: 0.7
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.5199

       # Near SST Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         test variables:
         - name: ObsFunction/NearSSTRetCheckIR
           channels: *abi_g16_channels
           options:
             channels: *abi_g16_channels
             use_flag: *abi_g16_use_flag
         maxvalue: 1.0e-12
         action:
           name: reject

       # Surface Jacobian
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsFunction/ObsErrorFactorSurfJacobianRad
             channels: *abi_g16_channels
             options:
               channels: *abi_g16_channels
               sensor: abi_g16
               obserr_demisf: [0.01, 0.02, 0.03, 0.02, 0.03]
               obserr_dtempf: [0.5, 2.0, 4.0, 2.0, 4.0]

       # Channels 7, 10-16 Cloud fraction >2
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: 7, 10-16
         where:
         - variable:
             name: MetaData/cloudAmount
           maxvalue: 2

       # Variable assignment, OmF non bias corrected
       - filter: Variable Assignment
         assignments:
         - name: OmFNBC@DerivedMetaData
           type: float
           function:
             name: ObsFunction/Arithmetic
             options:
               variables:
               - name: brightnessTemperature@ObsValue
                 channels: 13
               - name: brightnessTemperature@HofX
                 channels: 13
               - name: brightnessTemperature@ObsBiasData
                 channels: 13
               - name: brightnessTemperature@ObsValue
                 channels: 14
               - name: brightnessTemperature@HofX
                 channels: 14
               - name: brightnessTemperature@ObsBiasData
                 channels: 14
               coefs: [1, -1, 1, -1, 1, -1]

       # Use split window chns to remove opaque clouds
       # Toss Channels 7, 10-16, when OmFNBC < -0.75
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: 7, 10-16
         where:
         - variable:
             name: OmFNBC@DerivedMetaData
           minvalue: -0.75
           max_exclusive: true

       # Final gross check
       - filter: Background Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         function absolute threshold:
         - name: ObsFunction/ObsErrorBoundIR
           channels: *abi_g16_channels
           options:
             sensor: abi_g16
             channels: *abi_g16_channels
             obserr_bound_latitude:
               name: ObsFunction/ObsErrorFactorLatRad
               options:
                 latitude_parameters: [0.0, 0.0, 0.0, 0.0]
             obserr_bound_transmittop:
               name: ObsFunction/ObsErrorFactorTransmitTopRad
               channels: *abi_g16_channels
               options:
                 channels: *abi_g16_channels
             obserr_bound_max: *abi_g16_obserr_bound_max
             error parameter vector: *abi_g16_error
         action:
           name: reject
