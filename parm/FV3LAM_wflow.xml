{#

This is a Jinja-enabled Rocoto XML template. It is filled in using the
fill_template.py script, and is done automatically by the
generate_workflow.sh step of preparing a regional workflow configured
experiment.

See README.xml_templating.md for information on using the Templating mechanisms.
-#}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE workflow [

<!--
Parameters needed by the job scheduler.
-->
<!ENTITY ACCOUNT         "{{ account }}">
<!ENTITY SERVICE_ACCOUNT "{{ service_account }}">
<!ENTITY HPSS_ACCOUNT    "{{ hpss_account }}">
<!ENTITY SCHED           "{{ sched }}">
<!ENTITY QUEUE_DEFAULT   "{{ queue_default }}">
<!ENTITY QUEUE_HPSS      "{{ queue_hpss }}">
<!ENTITY QUEUE_FORECAST  "{{ queue_forecast }}">
<!ENTITY QUEUE_POST      "{{ queue_post }}">
<!ENTITY QUEUE_PRDGEN    "{{ queue_prdgen }}">
<!ENTITY QUEUE_ANALYSIS  "{{ queue_analysis }}">
<!ENTITY RRFS_RESERVE  {% if reservation %}"--reservation={{ reservation }}"{% else %}""{% endif %}>
<!ENTITY RRFS_POST_RESERVE  {% if reservation_post %}"--reservation={{ reservation_post }}"{% else %}""{% endif %}>

<!--
Workflow task names.
-->
<!ENTITY MAKE_GRID_TN            "{{ make_grid_tn }}">
<!ENTITY MAKE_OROG_TN            "{{ make_orog_tn }}">
<!ENTITY MAKE_SFC_CLIMO_TN       "{{ make_sfc_climo_tn }}">
<!ENTITY MAKE_ICS_TN             "{{ make_ics_tn }}">
<!ENTITY BLEND_ICS_TN            "{{ blend_ics_tn }}">
<!ENTITY MAKE_LBCS_TN            "{{ make_lbcs_tn }}">
<!ENTITY FORECAST_TN             "{{ forecast_tn }}">
<!ENTITY POST_TN                 "{{ post_tn }}">
<!ENTITY PRDGEN_TN               "{{ prdgen_tn }}">
<!ENTITY BUFRSND_TN              "{{ bufrsnd_tn }}">
<!ENTITY ANALYSIS_GSI_TN         "{{ analysis_gsi }}">
<!ENTITY ANALYSIS_GSIDIAG_TN     "{{ analysis_gsidiag }}">
<!ENTITY UPDATE_LBC_SOIL_TN      "{{ update_lbc_soil }}">
<!ENTITY OBSERVER_GSI_ENSMEAN_TN "{{ observer_gsi_ensmean }}">
<!ENTITY OBSERVER_GSI_TN         "{{ observer_gsi }}">
<!ENTITY PREP_CYC_SPINUP_TN      "{{ prep_cyc_spinup }}">
<!ENTITY PREP_CYC_PROD_TN        "{{ prep_cyc_prod }}">
<!ENTITY PREP_CYC_TN             "{{ prep_cyc }}">
<!ENTITY CALC_ENSMEAN_TN         "{{ calc_ensmean }}">
<!ENTITY PROCESS_RADAR_TN        "{{ process_radar }}">
<!ENTITY PROCESS_LIGHTNING_TN    "{{ process_lightning }}">
<!ENTITY PROCESS_BUFR_TN         "{{ process_bufr }}">
<!ENTITY ANALYSIS_NONVARCLD_TN   "{{ analysis_nonvarcld }}">
<!ENTITY SAVE_RESTART_TN         "{{ save_restart }}">
<!ENTITY SAVE_DA_OUTPUT_TN       "{{ save_da_output }}">
<!ENTITY PROCESS_SMOKE_TN        "{{ process_smoke }}">

<!ENTITY ANALYSIS_GSI_TN      "analysis_gsi">
<!ENTITY HYBRID_RADAR_REF_TN  "hybrid_radar_ref">
<!ENTITY ENKFUPDT_TN          "enkfupdt">
<!ENTITY ENKF_RADAR_REF_TN    "enkf_radarref">
<!ENTITY RECENTER_TN          "recenter">
<!ENTITY CLEAN_TN             "run_clean">

<!ENTITY TAG   "{{ tag }}">
<!ENTITY NET   "{{ net }}">
<!ENTITY RUN   "{{ run }}">
<!ENTITY envir "{{ envir }}">

<!--
Flags that determine whether to run the specific tasks.
-->
<!ENTITY RUN_TASK_MAKE_GRID      "{{ run_task_make_grid | upper }}">
<!ENTITY RUN_TASK_MAKE_OROG      "{{ run_task_make_orog | upper }}">
<!ENTITY RUN_TASK_MAKE_SFC_CLIMO "{{ run_task_make_sfc_climo | upper }}">

<!--
Number of physical cores per node for the current machine.  This is used
below in the <nodesize> tag, but that tag is not clearly documented.  This
parameter may be unnecessary since each task now has its own variable that
specifies the number of processes per node being used (the PPN_... entities).
-->
<!ENTITY NCORES_PER_NODE "{{ ncores_per_node }}">

<!--
Directories and files.
-->
<!ENTITY HOMErrfs                 "{{ homerrfs }}">
<!ENTITY LOG_BASEDIR              "{{ log_basedir }}">
<!ENTITY LOGDIR                   "{{ log_basedir }}/{{ run }}.@Y@m@d/@H">
<!ENTITY OBSPATH                  "{{ obspath }}">
<!ENTITY OBSPATH_PM               "{{ obspath_pm }}">
<!ENTITY DATAROOT                 "{{ dataroot }}">
<!ENTITY GESROOT                  "{{ gesroot }}">
<!ENTITY COMROOT                  "{{ comroot }}">
<!ENTITY ENSCTRL_DATAROOT         "{{ ensctrl_dataroot }}">
<!ENTITY ENSCTRL_GESROOT          "{{ ensctrl_gesroot }}">
<!ENTITY ENSCTRL_COMOUT           "{{ ensctrl_comout }}">
<!ENTITY RRFSE_FG_ROOT            "{{ rrfse_gesroot }}">
{%- if is_rtma %}
<!ENTITY FG_ROOT                  "{{ fg_rootdir }}">
{%- else %}
<!ENTITY FG_ROOT                  "{{ gesroot }}">
{%- endif %}
<!ENTITY GLOBAL_VAR_DEFNS_FP      "{{ global_var_defns_fp }}">
<!ENTITY LOAD_MODULES_RUN_TASK_FP "{{ load_modules_run_task_fp }}">

<!--
Reservation types.  Reservations specify the queue/partition and account
to use for a given task.  The "DEFAULT" reservation type is used for most
tasks.
-->
{%- if partition_default is not none %}
<!ENTITY RSRV_DEFAULT "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue><partition>{{ partition_default }}</partition><native>&RRFS_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_DEFAULT "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue>">
{%- endif %}
{%- if partition_forecast is not none %}
<!ENTITY RSRV_FORECAST "<account>&ACCOUNT;</account><queue>&QUEUE_FORECAST;</queue><partition>{{ partition_forecast }}</partition>">
{%- else %}
<!ENTITY RSRV_FORECAST "<account>&ACCOUNT;</account><queue>&QUEUE_FORECAST;</queue>">
{%- endif %}
{%- if partition_analysis is not none %}
<!ENTITY RSRV_ANALYSIS    "<account>&ACCOUNT;</account><queue>&QUEUE_ANALYSIS;</queue><partition>{{ partition_analysis }}</partition>">
<!ENTITY RSRV_ENKF    "<account>&ACCOUNT;</account><queue>&QUEUE_ANALYSIS;</queue><partition>{{ partition_analysis }}</partition><native>&RRFS_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_ANALYSIS    "<account>&ACCOUNT;</account><queue>&QUEUE_ANALYSIS;</queue>">
<!ENTITY RSRV_ENKF    "<account>&ACCOUNT;</account><queue>&QUEUE_ANALYSIS;</queue>">
{%- endif %}
{%- if partition_post is not none %}
<!ENTITY RSRV_POST    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_POST;</queue><partition>{{ partition_post }}</partition><native>&RRFS_POST_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_POST    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_POST;</queue>">
{%- endif %}
{%- if partition_prdgen is not none %}
<!ENTITY RSRV_PRDGEN    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_PRDGEN;</queue><partition>{{ partition_prdgen }}</partition><native>&RRFS_POST_RESERVE;</native>">
{%- else %}
<!ENTITY RSRV_PRDGEN    "<account>&SERVICE_ACCOUNT;</account><queue>&QUEUE_PRDGEN;</queue>">
{%- endif %}

<!--
define resources used for each tasks
-->
<!ENTITY RESOURCES_PROCESS_SMOKE    "<nodes>{{ nnodes_process_smoke }}:ppn={{ ppn_process_smoke }}</nodes>">
<!ENTITY RESOURCES_PROCESS_RADAR    "<nodes>{{ nnodes_process_radar }}:ppn={{ ppn_process_radar }}</nodes>">
<!ENTITY RESOURCES_PROCESS_LIGHTNING "<nodes>{{ nnodes_process_lightning }}:ppn={{ ppn_process_lightning }}</nodes>">
<!ENTITY RESOURCES_PROCESS_BUFR     "<nodes>{{ nnodes_process_bufr }}:ppn={{ ppn_process_bufr }}</nodes>">
<!ENTITY RESOURCES_PREP_CYC         "<nodes>{{ nnodes_prep_cyc }}:ppn={{ ppn_prep_cyc }}</nodes>">
<!ENTITY RESOURCES_SAVE_RESTART     "<nodes>{{ nnodes_save_restart }}:ppn={{ ppn_save_restart }}</nodes>">
<!ENTITY RESOURCES_RECENTER         "<nodes>{{ nnodes_recenter }}:ppn={{ ppn_recenter }}</nodes>">
<!ENTITY RESOURCES_UPDATE_LBC_SOIL  "<nodes>{{ nnodes_update_lbc_soil }}:ppn={{ ppn_update_lbc_soil }}</nodes>">
<!ENTITY RESOURCES_ANALYSIS_GSIDIAG "<nodes>{{ nnodes_analysis_gsidiag }}:ppn={{ ppn_analysis_gsidiag }}</nodes>">
<!ENTITY RESOURCES_PRDGEN           "<nodes>{{ nnodes_prdgen }}:ppn={{ ppn_prdgen }}</nodes>">
<!ENTITY RESOURCES_ANALYSIS_NONVARCLD "<nodes>{{ nnodes_analysis_nonvarcld }}:ppn={{ ppn_analysis_nonvarcld }}</nodes>">

{%- if machine in ["WCOSS2"]  %}
<!ENTITY RESOURCES_BUFRSND      "<nodes>{{ nnodes_bufrsnd }}:ppn={{ ppn_bufrsnd }}:tpp={{ tpp_bufrsnd }}</nodes>">
<!ENTITY RESOURCES_POST         "<nodes>{{ nnodes_post }}:ppn={{ ppn_post }}:tpp={{ tpp_post }}</nodes>">
<!ENTITY RESOURCES_ANALYSIS_ENKF "<nodes>{{ nnodes_analysis_enkf }}:ppn={{ ppn_analysis_enkf }}:tpp={{ tpp_analysis_enkf }}</nodes>">
<!ENTITY RESOURCES_MAKE_ICS     "<nodes>{{ nnodes_make_ics }}:ppn={{ ppn_make_ics }}:tpp={{ tpp_make_ics }}</nodes>">
<!ENTITY RESOURCES_BLEND_ICS    "<nodes>{{ nnodes_blend_ics }}:ppn={{ ppn_blend_ics }}</nodes>">
<!ENTITY RESOURCES_MAKE_LBCS    "<nodes>{{ nnodes_make_lbcs }}:ppn={{ ppn_make_lbcs }}:tpp={{ tpp_make_lbcs }}</nodes>">
<!ENTITY RESOURCES_ANALYSIS_GSI "<nodes>{{ nnodes_analysis_gsi }}:ppn={{ ppn_analysis_gsi }}:tpp={{ tpp_analysis_gsi }}</nodes>">
<!ENTITY RESOURCES_FORECAST_SPINUP  "<nodes>{{ nnodes_forecast }}:ppn={{ ppn_forecast }}:tpp={{ tpp_forecast }}</nodes>">
<!ENTITY RESOURCES_FORECAST_PROD    "<nodes>{{ nnodes_forecast }}:ppn={{ ppn_forecast }}:tpp={{ tpp_forecast }}</nodes>">
<!ENTITY NODESIZE_ALL    "">
<!ENTITY NATIVE_ALL          "<native>-l place=excl</native>">
<!ENTITY NATIVE_ANALYSIS_GSI "<native>-l place=excl</native>">
<!ENTITY NATIVE_FORECAST_SPINUP  "<native>-l place=excl</native>">
<!ENTITY NATIVE_FORECAST_PROD    "<native>-l place=excl</native>">
{%- if is_rtma %}
<!ENTITY NATIVE_NONVAR_CLD   "<native>-l place=excl:scatter</native>">
{%- endif %}
{%- elif machine in ["JET"] %}
<!ENTITY RESOURCES_BUFRSND     "<nodes>{{ nnodes_bufrsnd }}:ppn={{ ppn_bufrsnd }}</nodes>">
<!ENTITY RESOURCES_POST        "<nodes>{{ nnodes_post }}:ppn={{ ppn_post }}</nodes>">
<!ENTITY RESOURCES_ANALYSIS_ENKF "<nodes>{{ nnodes_analysis_enkf }}:ppn={{ ppn_analysis_enkf }}</nodes>">
<!ENTITY RESOURCES_MAKE_ICS    "<nodes>{{ nnodes_make_ics }}:ppn={{ ppn_make_ics }}</nodes>">
<!ENTITY RESOURCES_BLEND_ICS   "<nodes>{{ nnodes_blend_ics }}:ppn={{ ppn_blend_ics }}</nodes>">
<!ENTITY RESOURCES_MAKE_LBCS   "<nodes>{{ nnodes_make_lbcs }}:ppn={{ ppn_make_lbcs }}</nodes>">
<!ENTITY RESOURCES_ANALYSIS_GSI    "<cores>{{ ncores_analysis_gsi }}</cores>">
<!ENTITY RESOURCES_FORECAST_SPINUP "<cores>{{ ncores_forecast }}</cores>">
<!ENTITY RESOURCES_FORECAST_PROD   "<cores>{{ ncores_forecast }}</cores>">
<!ENTITY NODESIZE_ALL    "<nodesize>{{ ncores_per_node }}</nodesize>">
<!ENTITY NATIVE_ALL         "<native>--export=NONE</native>">
<!ENTITY NATIVE_ANALYSIS_GSI    "<native>{{ native_analysis_gsi }} &RRFS_RESERVE;</native>">
<!ENTITY NATIVE_FORECAST_SPINUP "<native>{{ native_forecast }} &RRFS_RESERVE;</native>">
<!ENTITY NATIVE_FORECAST_PROD   "<native>{{ native_forecast }} &RRFS_RESERVE;</native>">
{%- elif machine in ["HERA"] %}
<!ENTITY RESOURCES_BUFRSND      "<nodes>{{ nnodes_bufrsnd }}:ppn={{ ppn_bufrsnd }}</nodes>">
<!ENTITY RESOURCES_POST         "<nodes>{{ nnodes_post }}:ppn={{ ppn_post }}</nodes>">
<!ENTITY RESOURCES_ANALYSIS_ENKF "<nodes>{{ nnodes_analysis_enkf }}:ppn={{ ppn_analysis_enkf }}</nodes>">
<!ENTITY RESOURCES_MAKE_ICS     "<nodes>{{ nnodes_make_ics }}:ppn={{ ppn_make_ics }}</nodes>">
<!ENTITY RESOURCES_BLEND_ICS    "<nodes>{{ nnodes_blend_ics }}:ppn={{ ppn_blend_ics }}</nodes>">
<!ENTITY RESOURCES_MAKE_LBCS    "<nodes>{{ nnodes_make_lbcs }}:ppn={{ ppn_make_lbcs }}</nodes>">
<!ENTITY RESOURCES_ANALYSIS_GSI "<cores>{{ ncores_analysis_gsi }}</cores>">
<!ENTITY RESOURCES_FORECAST_SPINUP  "<nodes>{{ nnodes_forecast }}:ppn={{ ppn_forecast }}</nodes>">
<!ENTITY RESOURCES_FORECAST_PROD    "<nodes>{{ nnodes_forecast }}:ppn={{ ppn_forecast }}</nodes>">
<!ENTITY NODESIZE_ALL    "<nodesize>{{ ncores_per_node }}</nodesize>">
<!ENTITY NATIVE_ALL         "<native>--export=NONE</native>">
<!ENTITY NATIVE_ANALYSIS_GSI    "<native>{{ native_analysis_gsi }} &RRFS_RESERVE;</native>">
<!ENTITY NATIVE_FORECAST_SPINUP "">
<!ENTITY NATIVE_FORECAST_PROD   "">
{%- else %}
<!ENTITY RESOURCES_BUFRSND      "<nodes>{{ nnodes_bufrsnd }}:ppn={{ ppn_bufrsnd }}</nodes>">
<!ENTITY RESOURCES_POST         "<nodes>{{ nnodes_post }}:ppn={{ ppn_post }}</nodes>">
<!ENTITY RESOURCES_ANALYSIS_ENKF "<nodes>{{ nnodes_analysis_enkf }}:ppn={{ ppn_analysis_enkf }}</nodes>">
<!ENTITY RESOURCES_MAKE_ICS     "<nodes>{{ nnodes_make_ics }}:ppn={{ ppn_make_ics }}</nodes>">
<!ENTITY RESOURCES_BLEND_ICS    "<nodes>{{ nnodes_blend_ics }}:ppn={{ ppn_blend_ics }}</nodes>">
<!ENTITY RESOURCES_MAKE_LBCS    "<nodes>{{ nnodes_make_lbcs }}:ppn={{ ppn_make_lbcs }}</nodes>">
<!ENTITY RESOURCES_ANALYSIS_GSI "<nodes>{{ nnodes_analysis_gsi }}:ppn={{ ppn_analysis_gsi }}</nodes>">
<!ENTITY RESOURCES_FORECAST_SPINUP  "<nodes>{{ nnodes_forecast }}:ppn={{ ppn_forecast }}</nodes>">
<!ENTITY RESOURCES_FORECAST_PROD    "<nodes>{{ nnodes_forecast }}:ppn={{ ppn_forecast }}</nodes>">
<!ENTITY NODESIZE_ALL    "<nodesize>{{ ncores_per_node }}</nodesize>">
<!ENTITY NATIVE_ALL         "<native>--export=NONE</native>">
<!ENTITY NATIVE_ANALYSIS_GSI    "">
<!ENTITY NATIVE_FORECAST_SPINUP "">
<!ENTITY NATIVE_FORECAST_PROD   "">
{%- endif %}

<!ENTITY WALLTIME_PROCESS_SMOKE       "{{ wtime_process_smoke }}">
<!ENTITY WALLTIME_PROCESS_RADAR       "{{ wtime_process_radar }}">
<!ENTITY WALLTIME_PROCESS_BUFR        "{{ wtime_process_bufr }}">
<!ENTITY WALLTIME_PREP_CYC            "{{ wtime_prep_cyc }}">
<!ENTITY WALLTIME_SAVE_RESTART        "{{ wtime_save_restart }}">
<!ENTITY WALLTIME_RECENTER            "{{ wtime_recenter }}">
<!ENTITY WALLTIME_UPDATE_LBC_SOIL     "{{ wtime_update_lbc_soil }}">
<!ENTITY WALLTIME_PRDGEN              "{{ wtime_prdgen }}">
<!ENTITY WALLTIME_ANALYSIS_NONVARCLD  "{{ wtime_analysis_nonvarcld }}">
<!ENTITY WALLTIME_POST                "{{ wtime_post }}">
<!ENTITY WALLTIME_ANALYSIS_ENKF       "{{ wtime_analysis_enkf }}">
<!ENTITY WALLTIME_MAKE_ICS            "{{ wtime_make_ics }}">
<!ENTITY WALLTIME_BLEND_ICS           "{{ wtime_blend_ics }}">
<!ENTITY WALLTIME_MAKE_LBCS           "{{ wtime_make_lbcs }}">
<!ENTITY WALLTIME_ANALYSIS_GSI        "{{ wtime_analysis_gsi }}">
<!ENTITY WALLTIME_FORECAST_SPINUP     "{{ wtime_forecast_spinup }}">
<!ENTITY WALLTIME_FORECAST_PROD       "{{ wtime_forecast }}">
<!ENTITY WALLTIME_FORECAST_PROD_LONG  "{{ wtime_forecast_long }}">
<!ENTITY WALLTIME_ANALYSIS_GSIDIAG    "{{ wtime_analysis_gsidiag }}">
<!ENTITY WALLTIME_PROCESS_LIGHTNING   "{{ wtime_process_lightning }}">

<!ENTITY MEMO_PROCESS_SMOKE "{{ memo_process_smoke }}">
<!ENTITY MEMO_PROCESS_BUFR  "{{ memo_process_bufr }}">
<!ENTITY MEMO_PREP_CYC      "<memory>{{ memo_prep_cyc}}</memory>">
<!ENTITY MEMO_PRDGEN        "{{ memo_prdgen }}">
<!ENTITY MEMO_ANALYSIS_NONVARCLD "{{ memo_analysis_nonvarcld }}">
<!ENTITY MEMO_PROCESS_LIGHTNING  "{{ memo_process_lightning }}">

{%- if do_retro %}
<!ENTITY DEADLINE_PRE      "999:00:00">
<!ENTITY DEADLINE_ANALYSIS "999:00:00">
<!ENTITY DEADLINE_FORECAST "999:30:00">
<!ENTITY DEADLINE_POST     "999:00:00">
<!ENTITY DEADLINE_RECENTER "999:00:00">
<!ENTITY DEADLINE_SAVE_RESTART "999:00:00">
<!ENTITY WALL_LIMIT_PRE ''>
<!ENTITY WALL_LIMIT_ANALYSIS ''>
<!ENTITY WALL_LIMIT_FORECAST ''>
<!ENTITY WALL_LIMIT_POST ''>
<!ENTITY WALL_LIMIT_BUFR ''>
<!ENTITY WALL_LIMIT_BUFRSND ''>
<!ENTITY WALL_LIMIT_RECENTER ''>
<!ENTITY WALL_LIMIT_SAVE_RESTART ''>
{%- else %}
<!ENTITY DEADLINE_PRE      "16:00:00">
<!ENTITY DEADLINE_ANALYSIS "16:00:00">
<!ENTITY DEADLINE_FORECAST "23:30:00">
<!ENTITY DEADLINE_POST     "24:00:00">
<!ENTITY DEADLINE_RECENTER "24:00:00">
<!ENTITY DEADLINE_SAVE_RESTART "24:00:00">
<!ENTITY WALL_LIMIT_PRE '<deadline><cyclestr offset="&DEADLINE_PRE;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_ANALYSIS '<deadline><cyclestr offset="&DEADLINE_ANALYSIS;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_FORECAST '<deadline><cyclestr offset="&DEADLINE_FORECAST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_POST '<deadline><cyclestr offset="&DEADLINE_POST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_BUFR '<deadline><cyclestr offset="&DEADLINE_POST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_BUFRSND '<deadline><cyclestr offset="&DEADLINE_POST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_RECENTER '<deadline><cyclestr offset="&DEADLINE_RECENTER;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_SAVE_RESTART '<deadline><cyclestr offset="&DEADLINE_SAVE_RESTART;">@Y@m@d@H@M</cyclestr></deadline>'>
{%- endif %}

<!ENTITY START_TIME_SPINUP "{{ start_time_spinup }}">
<!ENTITY START_TIME_PROD "{{ start_time_prod }}">
<!ENTITY START_TIME_CONVENTIONAL_SPINUP "{{ start_time_conventional_spinup }}">
<!ENTITY START_TIME_BLENDING "{{ start_time_blending }}">
<!ENTITY START_TIME_LATE_ANALYSIS "{{ start_time_late_analysis }}">
<!ENTITY START_TIME_CONVENTIONAL "{{ start_time_conventional }}">
<!ENTITY START_TIME_NSSLMOSIAC   "{{ start_time_nsslmosiac }}">
<!ENTITY START_TIME_PROCESS_LIGHTNING  "{{ start_time_process_lightning }}">
<!ENTITY START_TIME_PROCESS_SMOKE  "{{ start_time_process_smoke }}">
<!ENTITY STARTYEAR  "{{ startyear }}">
<!ENTITY STARTMONTH "{{ startmonth }}">
<!ENTITY STARTDAY   "{{ startday }}">
<!ENTITY STARTHOUR  "{{ starthour }}">
<!ENTITY ENDYEAR  "{{ endyear }}">
<!ENTITY ENDMONTH "{{ endmonth }}">
<!ENTITY ENDDAY   "{{ endday }}">
<!ENTITY ENDHOUR  "{{ endhour }}">

]>

{%- if do_retro %}
<workflow realtime="F" scheduler="&SCHED;" cyclethrottle="12">
{% else %}
<workflow realtime="T" scheduler="&SCHED;" cyclethrottle="26" cyclelifespan="01:00:00:00">
{%- endif %}
{# Double quotes are required inside the strftime! Expect an error from reading the template if using single quotes. #}
  <cycledef group="at_start">{{ at_start_cycledef }} </cycledef>

  <cycledef group="initial"> {{ initial_cycledef }} </cycledef>
  <cycledef group="boundary"> {{ boundary_cycledef }} </cycledef>

  <cycledef group="spinupcyc"> {{ spinup_cycledef }} </cycledef>
  <cycledef group="prodcyc"> {{ prod_cycledef }} </cycledef>
  <cycledef group="prodcyc_long"> {{ prodlong_cycledef }} </cycledef>

{%- if do_save_da_output %}
  <cycledef group="savedacyc"> {{ saveda_cycledef }} </cycledef>
{%- endif %}
  <cycledef group="recentercyc"> {{ recenter_cycledef }} </cycledef>

  <log>
    <cyclestr>&LOGDIR;/FV3LAM_wflow_&TAG;.log</cyclestr>
  </log>

<!-- 
The following command works to call the J-job for a given task (in this
case the MAKE_GRID_TN task) if in the script LOAD_MODULES_RUN_TASK_FP we 
do NOT call exec to run the J-job.  The command first sources the script
LOAD_MODULES_RUN_TASK_FP and then runs the J-job, so it is simpler than
calling exec and thus preferred if NCO accepts it.  Note that the portion
of the command that sources LOAD_MODULES_RUN_TASK_FP also passes an 
argument to it (the argument being the name of the task).  This works in
bash but it probably won't work in sh.

If this method is acceptable to NCO, then for clarity maybe we can
source LOAD_MODULES_RUN_TASK_FP within the J-job instead of here since
we are already sourcing other files in the J-job anyway.
-->
<!--
    <command>{ . &LOAD_MODULES_RUN_TASK_FP; "&MAKE_GRID_TN;";
               &HOMErrfs;/jobs/JRRFS_MAKE_GRID;
             }</command>
-->
<!--
The following command works if we call exec in LOAD_MODULES_RUN_TASK_FP
to run the J-job.  This passes the J-job script as the second argument
to LOAD_MODULES_RUN_TASK_FP (the first argument is the task name).  The
J-job then uses exec to run the J-job (while also terminating the LOAD_-
MODULES_RUN_TASK_FP script.
-->

{%- if run_task_make_grid %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_GRID_TN;" cycledefs="at_start" maxtries="{{ maxtries_make_grid }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_GRID_TN;" "&HOMErrfs;/jobs/JRRFS_MAKE_GRID"</command>
    <nodes>{{ nnodes_make_grid }}:ppn={{ ppn_make_grid }}</nodes>
    <walltime>{{ wtime_make_grid }}</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&MAKE_GRID_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_GRID_TN;.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

  </task>
{% endif %}

{%- if run_task_make_orog %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_OROG_TN;" cycledefs="at_start" maxtries="{{ maxtries_make_orog }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_OROG_TN;" "&HOMErrfs;/jobs/JRRFS_MAKE_OROG"</command>
    <nodes>{{ nnodes_make_orog }}:ppn={{ ppn_make_orog }}</nodes>
    <walltime>{{ wtime_make_orog }}</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&MAKE_OROG_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_OROG_TN;.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <or>
        <taskdep task="&MAKE_GRID_TN;"/>
        <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
      </or>
    </dependency>

  </task>
{% endif %}

{%- if run_task_make_sfc_climo %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_SFC_CLIMO_TN;" cycledefs="at_start" maxtries="{{ maxtries_make_sfc_climo }}">

    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_SFC_CLIMO_TN;" "&HOMErrfs;/jobs/JRRFS_MAKE_SFC_CLIMO"</command>
    <nodes>{{ nnodes_make_sfc_climo }}:ppn={{ ppn_make_sfc_climo }}</nodes>
    <walltime>{{ wtime_make_sfc_climo }}</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&MAKE_SFC_CLIMO_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_SFC_CLIMO_TN;.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        <or>
          <taskdep task="&MAKE_GRID_TN;"/>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
          <taskdep task="&MAKE_OROG_TN;"/>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
{% endif %}


{%- if not do_ensfcst %}
<!-- beginning of meta block for prod spinup  -->
<metatask name="data_preprocessing">
  
{%- if do_spinup %}
  <var name="cycletype">spinupcyc prodcyc,prodcyc_long</var>
  <var name="type">spinup prod</var>
{% else %}
  <var name="cycletype">prodcyc,prodcyc_long</var>
  <var name="type">prod</var>
{%- endif %}

{%- if do_smoke_dust %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&PROCESS_SMOKE_TN;_#type#" cycledefs="#cycletype#"  maxtries="{{ maxtries_process_smoke }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&PROCESS_SMOKE_TN;" "&HOMErrfs;/jobs/JRRFS_PROCESS_SMOKE"</command>

    &RESOURCES_PROCESS_SMOKE;
    &NATIVE_ALL;
    <walltime>&WALLTIME_PROCESS_SMOKE;</walltime>
    <memory>&MEMO_PROCESS_SMOKE;</memory>
    &NODESIZE_ALL;
    <jobname>&TAG;_&PROCESS_SMOKE_TN;_#type#</jobname>
    <join><cyclestr>&LOGDIR;/&PROCESS_SMOKE_TN;_#type#_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        <timedep><cyclestr offset="&START_TIME_PROCESS_SMOKE;">@Y@m@d@H@M00</cyclestr></timedep>
      {%- if do_retro %}
      <datadep age="00:00:01:00"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
      {%- endif %}
      </and>
    </dependency>

  </task>
{%- endif %}

{%- if do_analysis_nonvarcld or do_enkf_radar_ref or do_envar_radar_ref %}
<!--
************************************************************************
************************************************************************
--> 
  <task name="&PROCESS_RADAR_TN;_#type#" cycledefs="#cycletype#"  maxtries="{{ maxtries_process_radar }}">
    
    &RSRV_DEFAULT;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_PROCESS_RADAR"</command>
      
    &RESOURCES_PROCESS_RADAR;
    &NATIVE_ALL;
    <walltime>&WALLTIME_PROCESS_RADAR;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&PROCESS_RADAR_TN;_#type#</jobname>
    <join><cyclestr>&LOGDIR;/&PROCESS_RADAR_TN;_#type#_&TAG;_@Y@m@d@H.log</cyclestr></join>
        
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>
    <envar><name>RADAR_REF_THINNING</name><value>{{ radar_ref_thinning }}</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>
        
    <dependency>
      <and>
        <timedep><cyclestr offset="&START_TIME_NSSLMOSIAC;">@Y@m@d@H@M00</cyclestr></timedep>
      </and>
    </dependency>

  </task>

{%- if do_glmfed_da %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&PROCESS_LIGHTNING_TN;_#type#" cycledefs="#cycletype#"  maxtries="{{ maxtries_process_lightning }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&PROCESS_SMOKE_TN;" "&HOMErrfs;/jobs/JRRFS_PROCESS_LIGHTNING"</command>

    &RESOURCES_PROCESS_LIGHTNING;
    &NATIVE_ALL;
    <walltime>&WALLTIME_PROCESS_LIGHTNING;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&PROCESS_LIGHTNING_TN;_#type#</jobname>
    <join><cyclestr>&LOGDIR;/&PROCESS_LIGHTNING_TN;_#type#_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>PREP_MODEL</name><value>0</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
        <timedep><cyclestr offset="&START_TIME_PROCESS_LIGHTNING;">@Y@m@d@H@M00</cyclestr></timedep>
    </dependency>

  </task>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
  <task name="&PROCESS_BUFR_TN;_#type#" cycledefs="#cycletype#"  maxtries="{{ maxtries_process_bufr }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_PROCESS_BUFR"</command>

    &RESOURCES_PROCESS_BUFR;
    &NATIVE_ALL;
    <walltime>&WALLTIME_PROCESS_BUFR;</walltime>
    <memory>&MEMO_PROCESS_BUFR;</memory>
    &NODESIZE_ALL;
    <jobname>&TAG;_&PROCESS_BUFR_TN;_#type#</jobname>
    <join><cyclestr>&LOGDIR;/&PROCESS_BUFR_TN;_#type#_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>#type#</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </and>
    </dependency>

  </task>

{%- endif %}

</metatask>
 
{% endif %}
<!--
************************************************************************
************************************************************************
-->
{% if not is_rtma %}
{%- if do_ensemble %}
 <metatask name="run_ensemble_pre">

  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}{{- fmtstr%m -}}{%- endfor %} </var>
  {%- if do_enscontrol %}
    <var name="subdirGE">/gec00{% for m in range(2, num_ens_members+1) %}{{ " /gep%02d"%m }}{% endfor %}</var>
    <var name="memNameWRF">_mem0000{% for m in range(2, num_ens_members+1) %}{{ " _mem%04d"%m }}{% endfor %} </var>
  {%- else %}
    <var name="subdirGE">{% for m in range(1, num_ens_members+1) %}{{ " /gep%02d"%m }}{% endfor %}</var>
    <var name="memNameWRF">{% for m in range(1, num_ens_members+1) %}{{ " _mem%04d"%m }}{% endfor %} </var>
    <var name="memNameGDAS">{% for m in range(1, num_ens_members+1) %}{{ " mem%03d"%m }}{% endfor %} </var>
  {%- endif %}
    <var name="subdirGDAS">{% for m in range(1, num_ens_members+1) %}{{ " /mem%03d"%m }}{% endfor %}</var>
{%- endif %}

<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_ICS_TN;{{ uscore_ensmem_name }}" cycledefs="initial" maxtries="{{ maxtries_make_ics }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_ICS_TN;" "&HOMErrfs;/jobs/JRRFS_MAKE_ICS"</command>
    &RESOURCES_MAKE_ICS;
    &NATIVE_ALL;
    <walltime>&WALLTIME_MAKE_ICS;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&MAKE_ICS_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_ICS_TN;_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>FG_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>EXTRN_MDL_NAME</name><value>{{ extrn_mdl_name_ics }}</value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>GEFS_INPUT_SUBDIR</name><value>#subdirGE#</value></envar>
    <envar><name>WRF_MEM_NAME</name><value>#memNameWRF#</value></envar>
    <envar><name>GDASENKF_INPUT_SUBDIR</name><value>#subdirGDAS#</value></envar>
    <envar><name>GDAS_MEM_NAME</name><value>#memNameGDAS#</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        <or>
          <taskdep task="&MAKE_GRID_TN;"/>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
          <taskdep task="&MAKE_OROG_TN;"/>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
          <taskdep task="&MAKE_SFC_CLIMO_TN;"/>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
        <or>
          {%- if machine in ["WCOSS2"]  %}
            {%- if extrn_mdl_name_ics in ["GFS"] %}
                {%- if do_retro %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
                {% else %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.atmf{{ "%03d" % extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
                {%- endif %}
            {%- elif extrn_mdl_name_ics in ["GDASENKF"] %}
            <and>
              <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.atmf00{{ extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
              <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.sfcf00{{ extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
            </and>
            {%- elif extrn_mdl_name_ics in ["GEFS"] %}
                {%- if do_retro %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/#subdirGE#/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
                {% else %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gefs.@Y@m@d/@H/atmos/pgrb2bp5/#subdirGE#.t@Hz.pgrb2b.0p50.f{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
                {%- endif %}
            {% else %}
                {%- if do_retro %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
                {% else %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.pgrb2.0p25.f{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
                {%- endif %}
            {%- endif %}
          {% else %}
          {%- if extrn_mdl_name_ics in ["GEFS"] %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/#subdirGE#/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
          {%- elif extrn_mdl_name_ics in ["GDASENKF"] %}
          <and>
          {%- if machine in ["HERA"] %}
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.atmf00{{ extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.sfcf00{{ extrn_mdl_ics_offset_hrs }}.nc</cyclestr></datadep>
          {%- elif machine in ["JET"] %}
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H00.gdas.t@Hz.atmf00{{ extrn_mdl_ics_offset_hrs }}.#memNameGDAS#.nc</cyclestr></datadep>
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H00.gdas.t@Hz.sfcf00{{ extrn_mdl_ics_offset_hrs }}.#memNameGDAS#.nc</cyclestr></datadep>
          {%- elif machine in ["ORION","HERCULES"] %}
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H00.gdas.t@Hz.atmf00{{ extrn_mdl_ics_offset_hrs }}.#memNameGDAS#.nc</cyclestr></datadep>
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H00.gdas.t@Hz.sfcf00{{ extrn_mdl_ics_offset_hrs }}.#memNameGDAS#.nc</cyclestr></datadep>
          {%- endif %}
          </and>
          {%- else %}
          {%- if machine in ["JET"] %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
          {%- elif machine in ["HERA"] %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
          {%- elif machine in ["ORION","HERCULES"] %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_ics }}/@y@j@H000{{ "%03d" % extrn_mdl_ics_offset_hrs }}</cyclestr></datadep>
          {%- endif %}
          {%- endif %}
          {%- endif %}
        </or>
      </and>
    </dependency>

  </task>

  {% if do_ens_blending %}
  <task name="&BLEND_ICS_TN;{{ uscore_ensmem_name }}" cycledefs="initial" maxtries="{{ maxtries_blend_ics }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&BLEND_ICS_TN;" "&HOMErrfs;/jobs/JRRFS_BLEND_ICS"</command>
    &RESOURCES_BLEND_ICS;
    &NATIVE_ALL;
    <walltime>&WALLTIME_BLEND_ICS;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&BLEND_ICS_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&BLEND_ICS_TN;_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>FG_ROOT</name><value>&FG_ROOT;</value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        <taskdep task="&MAKE_ICS_TN;{{ uscore_ensmem_name }}"/>
        <or>
        {%- if not do_retro %}
          <timedep><cyclestr offset="&START_TIME_BLENDING;">@Y@m@d@H@M00</cyclestr></timedep>
        {%- endif %}
          <and>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m001/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m002/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m003/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m004/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m005/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m006/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m007/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m008/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m009/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m010/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m011/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m012/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m013/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m014/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m015/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m016/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m017/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m018/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m019/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m020/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m021/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m022/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m023/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m024/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m025/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m026/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m027/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m028/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m029/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr offset="-1:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m030/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
          </and>
        </or>
      </and>
    </dependency>

  </task>
  {% endif %}

<!--
************************************************************************
************************************************************************
-->
<metatask name="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}">
  <var name="bcgrp">{% for h in range(0, boundary_proc_group_num) %}{{ " %02d" % h  }}{% endfor %}</var>

  <task name="&MAKE_LBCS_TN;_#bcgrp#{{ uscore_ensmem_name }}" cycledefs="boundary" maxtries="{{ maxtries_make_lbcs }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_LBCS_TN;" "&HOMErrfs;/jobs/JRRFS_MAKE_LBCS"</command>
    &RESOURCES_MAKE_LBCS;
    &NATIVE_ALL;
    <walltime>&WALLTIME_MAKE_LBCS;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&MAKE_LBCS_TN;_#bcgrp#{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_LBCS_TN;_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H_#bcgrp#.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>EXTRN_MDL_NAME</name><value>{{ extrn_mdl_name_lbcs }}</value></envar>
    <envar><name>BOUNDARY_LEN</name><value>{{ boundary_len_hrs }}</value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>GEFS_INPUT_SUBDIR</name><value>#subdirGE#</value></envar>
    <envar><name>GDASENKF_INPUT_SUBDIR</name><value>#subdirGDAS#</value></envar>
    <envar><name>GDAS_MEM_NAME</name><value>#memNameGDAS#</value></envar>
    <envar><name>bcgrp</name><value>#bcgrp#</value></envar>
    <envar><name>bcgrpnum</name><value>{{ boundary_proc_group_num }}</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        <or>
          <taskdep task="&MAKE_GRID_TN;"/>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
          <taskdep task="&MAKE_OROG_TN;"/>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
          <taskdep task="&MAKE_SFC_CLIMO_TN;"/>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
        <and> 
<!-- Dependencies from the GET_GEFS_LBCS task -->
        {%- if extrn_mdl_name_lbcs in ["GEFS"] %}
          {%- if machine in ["WCOSS2"]  %}
            {%- if do_retro %}
              {%- for h in range(extrn_mdl_lbcs_offset_hrs, boundary_len_hrs+extrn_mdl_lbcs_offset_hrs+1, 3) %}
            <datadep age="00:00:05:00"> <cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/#subdirGE#/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
              {%- endfor %}
            {% else %}
              {%- for h in range(extrn_mdl_lbcs_offset_hrs, boundary_len_hrs+extrn_mdl_lbcs_offset_hrs+1, 3) %}
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/gefs.@Y@m@d/@H/atmos/pgrb2bp5/#subdirGE#.t@Hz.pgrb2b.0p50.f{{ "%03d" % h }}</cyclestr></datadep>
              {%- endfor %}
            {%- endif %}
          {% else %}
            {%- for h in range(extrn_mdl_lbcs_offset_hrs, boundary_len_hrs+extrn_mdl_lbcs_offset_hrs+1, 3) %}
            <datadep age="00:00:05:00"> <cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/#subdirGE#/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
            {%- endfor %}
          {%- endif %}
<!-- Dependencies from the GET_EXTRN_LBCS task -->
        {%- else %}
          {%- for h in range(extrn_mdl_lbcs_offset_hrs, boundary_len_hrs+extrn_mdl_lbcs_offset_hrs+1, bc_update_interval) %}
          {%- if machine in ["WCOSS2"]  %}
            {%- if gfs_file_fmt_lbcs in ["netcdf"]  %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.atmf{{ "%03d" % h }}.nc</cyclestr></datadep>
            {%- else %}
              {%- if do_retro %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
              {%- else %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/gfs.@Y@m@d/@H/atmos/gfs.t@Hz.pgrb2.0p25.f{{ "%03d" % h }}</cyclestr></datadep>
              {%- endif %}
            {%- endif %}
          {%- else %}
          {%- if extrn_mdl_name_lbcs in ["GEFS"] %}
          <datadep age="00:00:05:00"> <cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/#subdirGE#/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
          {%- elif extrn_mdl_name_lbcs in ["GDASENKF"] %}
          {%- if machine in ["HERA"] %}
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.atmf{{ "%03d" % h }}.nc</cyclestr></datadep>
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/enkfgdas.@Y@m@d/@H/atmos/#subdirGDAS#/gdas.t@Hz.sfcf{{ "%03d" % h }}.nc</cyclestr></datadep>
          {%- elif machine in ["JET"] %}
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H00.gdas.t@Hz.atmf{{ "%03d" % h }}.#memNameGDAS#.nc</cyclestr></datadep>
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H00.gdas.t@Hz.sfcf{{ "%03d" % h }}.#memNameGDAS#.nc</cyclestr></datadep>
          {%- elif machine in ["ORION","HERCULES"] %}
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H00.gdas.t@Hz.atmf{{ "%03d" % h }}.#memNameGDAS#.nc</cyclestr></datadep>
            <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H00.gdas.t@Hz.sfcf{{ "%03d" % h }}.#memNameGDAS#.nc</cyclestr></datadep>
          {%- endif %}
          {%- else %}
          {%- if machine in ["JET"] %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
          {%- elif machine in ["HERA"] %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
          {%- elif machine in ["ORION","HERCULES"] %}
          <datadep age="00:00:05:00"><cyclestr offset="-{{ extrn_mdl_lbcs_offset_hrs }}:00:00">{{ extrn_mdl_sysbasedir_lbcs }}/@y@j@H000{{ "%03d" % h }}</cyclestr></datadep>
          {%- endif %}
          {%- endif %}
          {%- endif %}
          {%- endfor %}

        {%- endif %}
        </and>
      </and>
    </dependency>

  </task>

</metatask>

{%- if do_ensemble %}
</metatask>
{%- endif %}

{%- endif %}
{%- if not do_ensfcst %}
{%- if do_ensemble %}
 <metatask name="run_ensemble">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}{{- fmtstr%m -}}{%- endfor %} </var>
{%- endif %}

{%- if do_spinup %}
<!-- beginning of spinup block  -->
{%- if not do_ensinit %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&PREP_CYC_SPINUP_TN;{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_prep_cyc }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&PREP_CYC_TN;" "&HOMErrfs;/jobs/JRRFS_PREP_CYC"</command>

    &RESOURCES_PREP_CYC;
    &NATIVE_ALL;
    <walltime>&WALLTIME_PREP_CYC;</walltime>
    &NODESIZE_ALL;
    &MEMO_PREP_CYC;
    <jobname>&TAG;_&PREP_CYC_SPINUP_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&PREP_CYC_SPINUP_TN;_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>HH</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>FG_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>LBCS_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
 {%- if do_ensinit %}
    <envar><name>CYCLE_SUBTYPE</name><value><cyclestr>ensinit</cyclestr></value></envar>
 {%- endif %}
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <or>
<!-- for start spin up cycle -->
         <and>
           <or>
             {%- for h in cycl_hrs_spinstart %}
             <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
           </or>
           {% if do_ens_blending %}
           <taskdep task="&BLEND_ICS_TN;{{ uscore_ensmem_name }}"/>
           {% else %}
           <taskdep task="&MAKE_ICS_TN;{{ uscore_ensmem_name }}"/>
           {% endif %}
           <or>
             {%- for h in range(0,lbcs_search_hrs) %} 
             <metataskdep metatask="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}" cycle_offset="-{{ h }}:00:00"/>
             {%- endfor %}
           </or>
{%- if do_retro %}
  {%- if not do_ensemble %}
           <datadep age="00:00:10:00"><cyclestr offset="00:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast_spinup/INPUT/gfs_ctrl.nc</cyclestr></datadep>
  {%- endif %}
{%- else %}
           <timedep><cyclestr offset="&START_TIME_SPINUP;">@Y@m@d@H@M00</cyclestr></timedep>
{%- endif %}
         </and>
<!-- for continue spin up cycles  -->
         <and>
           {%- for h in cycl_hrs_spinstart %}
           <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
           {%- endfor %}
{%- if do_retro %}
  {%- if do_ensemble %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m#mem#/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
  {%- else %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
  {%- endif %}
{%- else %}
  <timedep><cyclestr offset="&START_TIME_CONVENTIONAL_SPINUP;">@Y@m@d@H@M00</cyclestr></timedep>
  {%- if do_ensemble %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m#mem#/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
  {%- else %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
  {%- endif %}
{%- endif %}
         </and>
       </or>
    </dependency>

  </task>

{%- endif %}
{% if do_ensinit -%}
<!--
************************************************************************
************************************************************************
-->
  <task name="&PREP_CYC_SPINUP_TN;_ensinit{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_prep_cyc }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&PREP_CYC_TN;" "&HOMErrfs;/jobs/JRRFS_PREP_CYC"</command>

    &RESOURCES_PREP_CYC;
    &NATIVE_ALL;
    <walltime>&WALLTIME_PREP_CYC;</walltime>
    &NODESIZE_ALL;
    &MEMO_PREP_CYC;
    <jobname>&TAG;_&PREP_CYC_SPINUP_TN;_ensinit{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&PREP_CYC_SPINUP_TN;_ensinit_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>HH</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>FG_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>LBCS_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
 {%- if do_ensinit %}
    <envar><name>CYCLE_SUBTYPE</name><value><cyclestr>ensinit</cyclestr></value></envar>
 {%- endif %}
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <or>
<!-- for start spin up cycle -->
         <and>
           <or>
             {%- for h in cycl_hrs_spinstart %}
             <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
           </or>
           {% if do_ens_blending %}
           <taskdep task="&BLEND_ICS_TN;{{ uscore_ensmem_name }}"/>
           {% else %}
           <taskdep task="&MAKE_ICS_TN;{{ uscore_ensmem_name }}"/>
           {% endif %}
           <or>
             {%- for h in range(0,lbcs_search_hrs) %} 
             <metataskdep metatask="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}" cycle_offset="-{{ h }}:00:00"/>
             {%- endfor %}
           </or>
{%- if do_retro %}
  {%- if not do_ensemble %}
           <datadep age="00:00:10:00"><cyclestr offset="00:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast_spinup/INPUT/gfs_ctrl.nc</cyclestr></datadep>
  {%- endif %}
{%- else %}
           <timedep><cyclestr offset="&START_TIME_SPINUP;">@Y@m@d@H@M00</cyclestr></timedep>
{%- endif %}
         </and>
<!-- for continue spin up cycles  -->
         <and>
           {%- for h in cycl_hrs_spinstart %}
           <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
           {%- endfor %}
{%- if do_retro %}
  {%- if do_ensemble %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m#mem#/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
  {%- else %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
  {%- endif %}
{%- else %}
  <timedep><cyclestr offset="&START_TIME_CONVENTIONAL_SPINUP;">@Y@m@d@H@M00</cyclestr></timedep>
  {%- if do_ensemble %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/m#mem#/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
  {%- else %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
  {%- endif %}
{%- endif %}
         </and>
       </or>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->
  <task name="&FORECAST_TN;_ensinit{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_forecast }}">

    &RSRV_FORECAST;
    &WALL_LIMIT_FORECAST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&FORECAST_TN;" "&HOMErrfs;/jobs/JRRFS_FORECAST"</command>
    &RESOURCES_FORECAST_SPINUP;
    <walltime>&WALLTIME_FORECAST_SPINUP;</walltime>
    &NATIVE_ALL;
    &NATIVE_FORECAST_SPINUP;
    &NODESIZE_ALL;
    <jobname>&TAG;_&FORECAST_TN;_ensinit{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&FORECAST_TN;_ensinit_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HH</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>CYCLE_SUBTYPE</name><value><cyclestr>ensinit</cyclestr></value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>RESTART_HRS</name><value><cyclestr>0</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
        <and>   
          <or>    
           {%- for h in cycl_hrs_spinstart %}
            <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
           {%- endfor %}
          </or>   
          <taskdep task="&PREP_CYC_SPINUP_TN;_ensinit{{ uscore_ensmem_name }}"/>
        </and>  
    </dependency>

  </task> 
<!--
************************************************************************
************************************************************************
-->
    <task name="&SAVE_RESTART_TN;_ensinit{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_save_restart }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_SAVE_RESTART;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&SAVE_RESTART_TN;" "&HOMErrfs;/jobs/JRRFS_SAVE_RESTART"</command>
      &RESOURCES_SAVE_RESTART;
      &NATIVE_ALL;
      <walltime>&WALLTIME_SAVE_RESTART;</walltime>
      &NODESIZE_ALL;
      &MEMO_PREP_CYC;
      <jobname>&TAG;_&SAVE_RESTART_TN;_ensinit{{ uscore_ensmem_name }}</jobname>
      <join><cyclestr>&LOGDIR;/&SAVE_RESTART_TN;_ensinit_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
      <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
      <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>0</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
      <envar><name>CYCLE_SUBTYPE</name><value><cyclestr>ensinit</cyclestr></value></envar>
      <envar><name>KEEPDATA</name><value>YES</value></envar>

      <dependency>
        <and>
          <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
          <or>
            <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_ensinit_m#mem#_&envir;_@H/RESTART/</cyclestr><cyclestr offset="{{ dt_atmos }}">@Y@m@d.@H@M@S.coupler.res</cyclestr></datadep>
            <datadep age="00:00:00:05"><cyclestr>&FG_ROOT;/&RUN;.@Y@m@d/@H/m#mem#/run_blending</cyclestr> </datadep>
          </or>
        </and>
      </dependency>

    </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&PREP_CYC_SPINUP_TN;{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_prep_cyc }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&PREP_CYC_TN;" "&HOMErrfs;/jobs/JRRFS_PREP_CYC"</command>
    &RESOURCES_PREP_CYC;
    &NATIVE_ALL;
    <walltime>&WALLTIME_PREP_CYC;</walltime>
    &NODESIZE_ALL;
    &MEMO_PREP_CYC;
    <jobname>&TAG;_&PREP_CYC_SPINUP_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&PREP_CYC_SPINUP_TN;_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HH</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>FG_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>LBCS_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>CYCLE_SUBTYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>ENSCTRL_DATAROOT</name><value>&ENSCTRL_DATAROOT;</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
       {% if do_ens_blending %}
       <taskdep task="&BLEND_ICS_TN;_m#mem#"/>
       {% else %}
       <taskdep task="&MAKE_ICS_TN;_m#mem#"/>
       {% endif %}
       <taskdep task="&SAVE_RESTART_TN;_ensinit{{ uscore_ensmem_name }}"/>
       <datadep age="00:00:00:05"><cyclestr>&ENSCTRL_COMOUT;/@H_spinup/analysis_nonvarcld_complete.txt</cyclestr></datadep>
      </and>
    </dependency>

  </task>
{%- endif %}
{%- if do_ens_blending or do_ensinit %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&RECENTER_TN;_spinup" cycledefs="spinupcyc" maxtries="{{ maxtries_recenter }}">
    &RSRV_ENKF;
    &WALL_LIMIT_RECENTER;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&RECENTER_TN;" &HOMErrfs;/jobs/JRRFS_RECENTER</command>
    &RESOURCES_RECENTER;
    &NATIVE_ALL;
    <walltime>&WALLTIME_RECENTER;</walltime>
    &NODESIZE_ALL;
    <jobname><cyclestr>&TAG;_&RECENTER_TN;_spinup</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/&RECENTER_TN;_spinup_&TAG;@Y@m@d@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>ENSCTRL_DATAROOT</name><value>&ENSCTRL_DATAROOT;</value></envar>
    <envar><name>ENSCTRL_GESROOT</name><value><cyclestr>&ENSCTRL_GESROOT;</cyclestr></value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        {%- for m in range(1, num_ens_members+1) %}
        {%- if do_ensinit %}
          <taskdep task="&PREP_CYC_SPINUP_TN;_mem{{ "%04d" % m }}"/>
        {%- endif %}
        {%- endfor %}
        <datadep age="00:00:00:05"><cyclestr>&ENSCTRL_COMOUT;/@H_spinup/analysis_nonvarcld_complete.txt</cyclestr></datadep>
      </and>
    </dependency>
  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&CALC_ENSMEAN_TN;_spinup" cycledefs="spinupcyc" maxtries="{{ maxtries_prep_cyc }}">

    &RSRV_ENKF;
    &WALL_LIMIT_RECENTER;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_RECENTER_TN;" "&HOMErrfs;/jobs/JRRFS_CALC_ENSMEAN"</command>
    &RESOURCES_RECENTER;
    &NATIVE_ALL;
    <walltime>&WALLTIME_RECENTER;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&CALC_ENSMEAN_TN;_spinup</jobname>
    <join><cyclestr>&LOGDIR;/&CALC_ENSMEAN_TN;_spinup_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
         <and>
         <taskdep task="&RECENTER_TN;_spinup"/>
         <datadep age="00:00:00:05"><cyclestr>&FG_ROOT;/&RUN;.@Y@m@d/@H/m#mem#/run_blending</cyclestr></datadep>
         </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&OBSERVER_GSI_ENSMEAN_TN;_spinup" cycledefs="spinupcyc" maxtries="{{ maxtries_analysis_gsi }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_GSI"</command>
    &RESOURCES_ANALYSIS_GSI;
    &NATIVE_ANALYSIS_GSI;
    <walltime>&WALLTIME_ANALYSIS_GSI;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&OBSERVER_GSI_ENSMEAN_TN;_spinup</jobname>
    <join><cyclestr>&LOGDIR;/&OBSERVER_GSI_ENSMEAN_TN;_spinup_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>OBSERVER</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEAN</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value>&GESROOT;/satbias</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <and>
         <taskdep task="&CALC_ENSMEAN_TN;_spinup"/>
         {%- if do_enkf_radar_ref %}
         <taskdep task="&PROCESS_RADAR_TN;_spinup"/>
         {%- endif %}
         <or>
           <datadep age="02:00"><cyclestr>&OBSPATH;/@Y@m@d@H.rap.t@Hz.prepbufr.tm00</cyclestr></datadep>
           <datadep age="02:00"><cyclestr>&OBSPATH;/rap.@Y@m@d/rap.t@Hz.prepbufr.tm00</cyclestr></datadep>
         </or>
       </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
 <metatask name="run_ensemble_observer_spinup">
   <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}
    {%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}
    {{- fmtstr%m -}}
   {%- endfor %} </var>

  <task name="&OBSERVER_GSI_TN;_spinup{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_analysis_gsi }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_GSI"</command>
    &RESOURCES_ANALYSIS_GSI;
    &NATIVE_ANALYSIS_GSI;
    <walltime>&WALLTIME_ANALYSIS_GSI;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&OBSERVER_GSI_TN;_spinup{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&OBSERVER_GSI_TN;_spinup_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</cyclestr></value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>OBSERVER</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value>&GESROOT;/satbias</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <and>
         <taskdep task="&OBSERVER_GSI_ENSMEAN_TN;_spinup"/>
       </and>
    </dependency>

  </task>

  </metatask>
{%- endif %}

{%- if do_enkfupdate %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ENKFUPDT_TN;_spinup" cycledefs="spinupcyc" maxtries="{{ maxtries_analysis_enkf }}">
    &RSRV_ENKF;
    &WALL_LIMIT_ANALYSIS;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&ENKFUPDT_TN;" &HOMErrfs;/jobs/JRRFS_ANALYSIS_ENKF</command>

    &RESOURCES_ANALYSIS_ENKF;
    <walltime>&WALLTIME_ANALYSIS_ENKF;</walltime>
    &NODESIZE_ALL;
    <jobname><cyclestr>&TAG;_&ENKFUPDT_TN;_spinup</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/&ENKFUPDT_TN;_spinup_&TAG;_@Y@m@d@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>OB_TYPE</name><value>conv</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
        <metataskdep metatask="run_ensemble_observer_spinup"/>
    </dependency>
  </task>

{%- endif %}

{%- if do_enkf_radar_ref %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ENKF_RADAR_REF_TN;_spinup" cycledefs="spinupcyc" maxtries="{{ maxtries_analysis_enkf }}">
    &RSRV_ENKF;
    &WALL_LIMIT_ANALYSIS;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&ENKF_RADAR_REF_TN;" &HOMErrfs;/jobs/JRRFS_ANALYSIS_ENKF</command>

    &RESOURCES_ANALYSIS_ENKF;
    <walltime>&WALLTIME_ANALYSIS_ENKF;</walltime>
    &NODESIZE_ALL;
    <jobname><cyclestr>&TAG;_&ENKF_RADAR_REF_TN;_spinup</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/&ENKF_RADAR_REF_TN;_spinup_&TAG;_@Y@m@d@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>OB_TYPE</name><value>radardbz</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        <taskdep task="&ENKFUPDT_TN;_spinup"/>
        {%- if do_retro %}
        <and> 
        {%- for m in range(1, num_ens_members+1) %}

          <datadep age="00:00:00:01"><cyclestr>&GESROOT;/&RUN;.@Y@m@d/@H/m{{ "%03d" % m }}/observer_gsi_spinup/diag_conv_dbz_ges.@Y@m@d@H.nc4.gz</cyclestr></datadep>
        {%- endfor %}
        </and> 
        {%- endif %}
      </and>
    </dependency>
  </task>

{%- endif %}

{% if do_ensemble and do_analysis_nonvarcld %}
 <metatask name="run_ensemble">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}{{- fmtstr%m -}}{%- endfor %} </var>

<!--
************************************************************************
************************************************************************
-->
  <task name="&ANALYSIS_NONVARCLD_TN;_spinup{{ uscore_ensmem_name }}" cycledefs="spinupcyc"  maxtries="{{ maxtries_analysis_nonvarcld }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_NONVARCLD"</command>

    &RESOURCES_ANALYSIS_NONVARCLD;
    <walltime>&WALLTIME_ANALYSIS_NONVARCLD;</walltime>
    &NATIVE_ALL;
    &NODESIZE_ALL;

    <jobname>&TAG;_&ANALYSIS_NONVARCLD_TN;_spinup{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&ANALYSIS_NONVARCLD_TN;_spinup_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        <taskdep task="&PROCESS_BUFR_TN;_spinup"/>
        {%- if do_enkfupdate %}
        <and>
           {%- if do_enkf_radar_ref %}
             <taskdep task="&ENKF_RADAR_REF_TN;_spinup"/>
           {%- else %}
             <taskdep task="&ENKFUPDT_TN;"/>
           {%- endif %}
        </and>
        {%- elif do_envar_radar_ref and not do_envar_radar_ref_once %}
        <or>
          <and>
            <taskdep task="&UPDATE_LBC_SOIL_TN;_prod{{ uscore_ensmem_name }}"/>
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
             {%- endfor %}
          </and>
          <and>
            <taskdep task="&HYBRID_RADAR_REF_TN;_prod"/>
            <or>    
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
            </or>   
          </and>
        </or>
        {%- else %}
        <taskdep task="&UPDATE_LBC_SOIL_TN;_prod{{ uscore_ensmem_name }}"/>
        {%- endif %}
      </and>
    </dependency>

  </task>
 </metatask>
{%- endif %}

{%- if not do_ensemble %}
{%- if do_dacycle %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ANALYSIS_GSI_TN;_spinup{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_analysis_gsi }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_GSI"</command>
    &RESOURCES_ANALYSIS_GSI;
    &NATIVE_ANALYSIS_GSI;
    <walltime>&WALLTIME_ANALYSIS_GSI;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&ANALYSIS_GSI_TN;_spinup{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&ANALYSIS_GSI_TN;{{ uscore_ensmem_name }}_spinup_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&GESROOT;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    {%- if do_envar_radar_ref and do_envar_radar_ref_once %}
    <envar><name>OB_TYPE</name><value>conv_dbz</value></envar>
    {%- endif %}
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <and>
         <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
         <taskdep task="&PREP_CYC_TN;_spinup{{ uscore_ensmem_name }}"/>
         {%- if use_rrfse_ens %}
         {%- if do_retro %}
         <and>
             {%- if do_envar_radar_ref and do_envar_radar_ref_once %}
             <taskdep task="&PROCESS_RADAR_TN;_spinup"/>
             {%- endif %}
             <or>
               <and> 
                 <or>
             {%- for h in cycl_hrs_prodstart_ens %}
               <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
                 </or>
             {% for h in range(1, num_ens_members+1) %}
             <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&RRFSE_FG_ROOT;/&RUN;.@Y@m@d/@H/m{{ "%03d" % h  }}/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             {%- endfor %}
               </and>
               <and> 
             {%- for h in cycl_hrs_prodstart_ens %}
               <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
             {%- endfor %}
             {% for h in range(1, num_ens_members+1) %}
             <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&RRFSE_FG_ROOT;/&RUN;.@Y@m@d/@H/m{{ "%03d" % h  }}/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             {%- endfor %}
               </and>
             </or>
         </and>
         {%- endif %}
         {%- endif %}
       </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&UPDATE_LBC_SOIL_TN;_spinup{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_update_lbc_soil }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_POST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&POST_TN;" "&HOMErrfs;/jobs/JRRFS_UPDATE_LBC_SOIL"</command>
    &RESOURCES_UPDATE_LBC_SOIL;
    &NATIVE_ALL;
    <walltime>&WALLTIME_UPDATE_LBC_SOIL;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&UPDATE_LBC_SOIL_TN;_spinup{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&UPDATE_LBC_SOIL_TN;{{ uscore_ensmem_name }}_spinup_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&GESROOT;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    {%- if do_envar_radar_ref and do_envar_radar_ref_once %}
    <envar><name>OB_TYPE</name><value>conv_dbz</value></envar>
    {%- endif %}
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <taskdep task="&ANALYSIS_GSI_TN;_spinup{{ uscore_ensmem_name }}"/>
    </dependency>

  </task>

{%- if do_envar_radar_ref and not do_envar_radar_ref_once %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&HYBRID_RADAR_REF_TN;_spinup" cycledefs="spinupcyc" maxtries="{{ maxtries_analysis_gsi }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&HYBRID_RADAR_REF_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_GSI"</command>
    &RESOURCES_ANALYSIS_GSI;
    &NATIVE_ANALYSIS_GSI;
    <walltime>&WALLTIME_ANALYSIS_GSI;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&HYBRID_RADAR_REF_TN;_spinup</jobname>
    <join><cyclestr>&LOGDIR;/&HYBRID_RADAR_REF_TN;spinup_&TAG;@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&GESROOT;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>30</value></envar>
    <envar><name>OB_TYPE</name><value>radardbz</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <and>
         <taskdep task="&PROCESS_RADAR_TN;_spinup"/>
         <taskdep task="&ANALYSIS_GSI_TN;_spinup"/>
         <or>    
            {%- for h in cycl_hrs_hyb_fv3lam_ens %}
               <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
            {%- endfor %}
         </or>   
       </and>
    </dependency>

  </task>

{% endif -%}

{%- if do_gsidiag_offline %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ANALYSIS_GSIDIAG_TN;_spinup" cycledefs="spinupcyc" maxtries="{{ maxtries_analysis_gsi }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_GSIDIAG"</command>
    &RESOURCES_ANALYSIS_GSIDIAG;
    &NATIVE_ALL;
    <walltime>&WALLTIME_ANALYSIS_GSIDIAG;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&ANALYSIS_GSIDIAG_TN;_spinup</jobname>
    <join><cyclestr>&LOGDIR;/&ANALYSIS_GSIDIAG_TN;_spinup_&TAG;@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&GESROOT;/satbias</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <and>
         <taskdep task="&ANALYSIS_GSI_TN;_spinup"/>
{%- if do_envar_radar_ref and not do_envar_radar_ref_once %}
         <taskdep task="&HYBRID_RADAR_REF_TN;_spinup"/>
{%- endif %}
       </and>
    </dependency>

  </task>

{%- endif %}

{%- endif %}

{%- if do_analysis_nonvarcld %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ANALYSIS_NONVARCLD_TN;_spinup{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_analysis_nonvarcld }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_NONVARCLD"</command>

    &RESOURCES_ANALYSIS_NONVARCLD;
    <walltime>&WALLTIME_ANALYSIS_NONVARCLD;</walltime>
    &NATIVE_ALL;
    &NODESIZE_ALL;

    <jobname>&TAG;_&ANALYSIS_NONVARCLD_TN;_spinup{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&ANALYSIS_NONVARCLD_TN;_spinup_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        <taskdep task="&PROCESS_BUFR_TN;_spinup"/>
        {%- if do_enkfupdate %}
        <and>
           {%- if do_enkf_radar_ref %}
             <taskdep task="&ENKF_RADAR_REF_TN;"/>
           {%- else %}
             <taskdep task="&ENKFUPDT_TN;"/>
           {%- endif %}
        </and>
        {%- elif do_envar_radar_ref and not do_envar_radar_ref_once %}
        <or>
          <and>
            <taskdep task="&UPDATE_LBC_SOIL_TN;_spinup{{ uscore_ensmem_name }}"/>
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
             {%- endfor %}
          </and>
          <and>
	    <taskdep task="&HYBRID_RADAR_REF_TN;_spinup"/>
            <or>    
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
            </or>   
          </and>
        </or>
        {%- else %}
	<taskdep task="&UPDATE_LBC_SOIL_TN;_spinup{{ uscore_ensmem_name }}"/>
        {%- endif %}
      </and>
    </dependency>

  </task>

{%- endif %}
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&FORECAST_TN;_spinup{{ uscore_ensmem_name }}" cycledefs="spinupcyc" maxtries="{{ maxtries_forecast }}">

    &RSRV_FORECAST;
    &WALL_LIMIT_FORECAST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&FORECAST_TN;" "&HOMErrfs;/jobs/JRRFS_FORECAST"</command>
    &RESOURCES_FORECAST_SPINUP;
    <walltime>&WALLTIME_FORECAST_SPINUP;</walltime>
    &NATIVE_ALL;
    &NATIVE_FORECAST_SPINUP;
    &NODESIZE_ALL;
    <jobname>&TAG;_&FORECAST_TN;_spinup{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&FORECAST_TN;_spinup_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HH</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>RESTART_HRS</name><value><cyclestr>1</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>
  
    <dependency>
      {%- if do_dacycle and do_analysis_nonvarcld%}
      <taskdep task="&ANALYSIS_NONVARCLD_TN;_spinup"/>
      {%- elif do_dacycle %}
        {%- if do_envar_radar_ref and not do_envar_radar_ref_once %}
        <taskdep task="&HYBRID_RADAR_REF_TN;_spinup"/>
        {%- else  %}
        <taskdep task="&UPDATE_LBC_SOIL_TN;_spinup{{ uscore_ensmem_name }}"/>
        {%- endif %}
      {%- elif do_enkfupdate or do_enkf_radar_ref %}
        <and>
          <or>
          {%- for h in cycl_hrs_spinstart %}
            <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
          {%- endfor %}
          </or>
          <or>
          {%- if do_ensinit or do_ens_blending %}
            <and>
              <datadep age="00:00:00:05"><cyclestr>&FG_ROOT;/&RUN;.@Y@m@d/@H/m#mem#/run_ensinit</cyclestr></datadep>
              <taskdep task="&RECENTER_TN;_spinup"/>
            </and>
            <and>
              <datadep age="00:00:00:05"><cyclestr>&FG_ROOT;/&RUN;.@Y@m@d/@H/m#mem#/run_blending</cyclestr></datadep>
              <taskdep task="&ANALYSIS_NONVARCLD_TN;_spinup_m#mem#"/>
            </and>
          {%- else  %}
          <taskdep task="&PREP_CYC_TN;_spinup{{ uscore_ensmem_name }}"/>
          {%- endif %}
          </or>
        </and>
      {%- else %}
      <taskdep task="&PREP_CYC_TN;_spinup{{ uscore_ensmem_name }}"/>
      {%- endif %}
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <metatask name="&SAVE_RESTART_TN;_spinup">

    <var name="fhr"> {% for h in range(da_cycle_interval_hrs, fcst_len_hrs_spinup+da_cycle_interval_hrs, da_cycle_interval_hrs) %}{{ " %03d" % h  }}{% endfor %} </var>

    <task name="&SAVE_RESTART_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#" cycledefs="spinupcyc" maxtries="{{ maxtries_save_restart }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_SAVE_RESTART;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&SAVE_RESTART_TN;" "&HOMErrfs;/jobs/JRRFS_SAVE_RESTART"</command>
      &RESOURCES_SAVE_RESTART;
      &NATIVE_ALL;
      <walltime>&WALLTIME_SAVE_RESTART;</walltime>
      &NODESIZE_ALL;
      &MEMO_PREP_CYC;
      <jobname>&TAG;_&SAVE_RESTART_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&SAVE_RESTART_TN;_spinup_&TAG;{{ uscore_ensmem_name }}_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
      <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
      <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
      <envar><name>KEEPDATA</name><value>YES</value></envar>

      <dependency>
        <and>
          <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
          <or>
            {%- if do_ensemble %}
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_spinup_m#mem#_&envir;_@H/RESTART/coupler.res</cyclestr></datadep>
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_spinup_m#mem#_&envir;_@H/RESTART/</cyclestr><cyclestr offset="#fhr#:00:00">@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
            {%- else %}
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_spinup_&envir;_@H/RESTART/coupler.res</cyclestr></datadep>
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_spinup_&envir;_@H/RESTART/</cyclestr><cyclestr offset="#fhr#:00:00">@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
            {%- endif %}
          </or>
        </and>
      </dependency>

    </task>

  </metatask>

{% if do_post_spinup %}
<!--
************************************************************************
************************************************************************
-->
  <metatask name="&POST_TN;_spinup{{ uscore_ensmem_name }}">

    <var name="fhr"> {% for h in range(0, fcst_len_hrs_spinup+1) %}{{ " %03d" % h  }}{% endfor %} </var>

    <task name="&POST_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#" cycledefs="spinupcyc" maxtries="{{ maxtries_post }}">

      &RSRV_POST;
      &WALL_LIMIT_POST;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&POST_TN;" "&HOMErrfs;/jobs/JRRFS_POST"</command>
      &RESOURCES_POST;
      &NATIVE_ALL;
      <walltime>&WALLTIME_POST;</walltime>
      &NODESIZE_ALL;
      <jobname>&TAG;_&POST_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&POST_TN;_spinup_&TAG;{{ uscore_ensmem_name }}_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
      <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
      <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
      <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
      <envar><name>KEEPDATA</name><value>YES</value></envar>

      <dependency>
        {%- if do_ensemble %}
          <datadep age="02:30"><cyclestr>&DATAROOT;/&RUN;_forecast_spinup_m#mem#_&envir;_@H/log.atm.f#fhr#</cyclestr></datadep>
        {%- else %}
          <datadep age="02:30"><cyclestr>&DATAROOT;/&RUN;_forecast_spinup_&envir;_@H/log.atm.f#fhr#</cyclestr></datadep>
        {%- endif %}
      </dependency>

    </task>
<!--
************************************************************************
************************************************************************
-->
    <task name="&PRDGEN_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#" cycledefs="spinupcyc" maxtries="{{ maxtries_prdgen }}">

      &RSRV_PRDGEN;
      &WALL_LIMIT_POST;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&PRDGEN_TN;" "&HOMErrfs;/jobs/JRRFS_PRDGEN"</command>
      &RESOURCES_PRDGEN;
      &NATIVE_ALL;
      <walltime>&WALLTIME_PRDGEN;</walltime>
      <memory>&MEMO_PRDGEN;</memory>
      &NODESIZE_ALL;
      <jobname>&TAG;_&PRDGEN_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&PRDGEN_TN;_spinup_&TAG;{{ uscore_ensmem_name }}_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
      <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
      <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>spinup</cyclestr></value></envar>
      <envar><name>KEEPDATA</name><value>YES</value></envar>

      <dependency>
        <taskdep task="&POST_TN;_spinup{{ uscore_ensmem_name }}_f#fhr#"/>
      </dependency>

    </task>

  </metatask>
{%- endif %}

<!-- end of spinup block -->
{%- endif %}

{%- if do_ensemble %}
</metatask>
{%- endif %}

{%- endif %}  <!-- not do_ensfcst -->

<!-- beginning of prod block -->
{%- if do_ensemble %}
 <metatask name="run_ensemble">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}{{- fmtstr%m -}}{%- endfor %} </var>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&PREP_CYC_PROD_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_prep_cyc }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&PREP_CYC_TN;" "&HOMErrfs;/jobs/JRRFS_PREP_CYC"</command>
    &RESOURCES_PREP_CYC;
    &NATIVE_ALL;
    <walltime>&WALLTIME_PREP_CYC;</walltime>
    &NODESIZE_ALL;
    &MEMO_PREP_CYC;
    <jobname>&TAG;_&PREP_CYC_PROD_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&PREP_CYC_PROD_TN;_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HH</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>FG_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>LBCS_ROOT</name><value><cyclestr>&FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
     {%- if do_ensfcst %}
       <and>
         <datadep age="00:00:05:00"><cyclestr>&FG_ROOT;/&RUN;.@Y@m@d/@H/m#mem#/forecast/DA_OUTPUT/coupler.res</cyclestr></datadep>
         <metataskdep metatask="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}"/>
       </and>
     {%- else %}
       <or>
<!-- for start product cycle -->
         <and>
           <or>
             {%- for h in cycl_hrs_prodstart %}
             <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
           </or>
{%- if do_spinup %}
{%- if do_retro %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
{% else %}
           <or>
             <and>
               <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
               <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             </and>
             <and>
               <timedep><cyclestr offset="&START_TIME_PROD;">@Y@m@d@H@M00</cyclestr></timedep>
               <or>
                 {%- for h in range(da_cycle_interval_hrs, 6+1, da_cycle_interval_hrs) %}
                 <datadep age="00:00:01:00"><cyclestr offset="-{{ h }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
                 {%- endfor %}
               </or>
             </and>
           </or>
{%- endif %}
{% else %}
{%- if do_retro %}
           <and>
             <datadep age="00:00:05:00"><cyclestr>&FG_ROOT;/&RUN;.@Y@m@d/@H/ics/gfs_data.tile7.halo0.nc</cyclestr></datadep>
             <or>
             {%- for h in range(0, extrn_mdl_ics_offset_hrs+1) %}
             <datadep age="00:00:05:00"><cyclestr offset="-{{ h }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/lbcs/gfs_bndy.tile7.{{ "%03d" % boundary_len_hrs }}.nc</cyclestr></datadep>
             {%- endfor %}
             </or>
           </and>
{% else %}
           <and>
             <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
             {% if do_ens_blending %}
             <taskdep task="&BLEND_ICS_TN;{{ uscore_ensmem_name }}"/>
             {% else %}
             <taskdep task="&MAKE_ICS_TN;{{ uscore_ensmem_name }}"/>
             {% endif %}
             {%- if not is_rtma %}
             <or>
               <metataskdep metatask="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}"/>
               <metataskdep metatask="&MAKE_LBCS_TN;{{ uscore_ensmem_name }}" cycle_offset="-{{ extrn_mdl_ics_offset_hrs }}:00:00"/>
             </or>
             {%- endif %}
           </and>
{%- endif %}
{%- endif %}
         </and>
<!-- for continue product cycles  -->
         <and>
           {%- for h in cycl_hrs_prodstart %}
           <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
           {%- endfor %}
{%- if do_retro %}
           <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
{% else %}
           <or>
             <and>
               <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
               <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
{%- if is_rtma %}
{%- if machine in ["WCOSS2"]  %}
               <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/@Y@m@d@H/m#mem#/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.fv_tracer.res.tile1.nc</cyclestr></datadep>
               <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/@Y@m@d@H/m#mem#/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.phy_data.nc</cyclestr></datadep>
               <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/@Y@m@d@H/m#mem#/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.fv_core.res.tile1.nc</cyclestr></datadep>
               <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&FG_ROOT;/@Y@m@d@H/m#mem#/fcst_fv3lam/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.sfc_data.nc</cyclestr></datadep>
{%- endif %}
{%- endif %}
             </and>
             <and>
               <timedep><cyclestr offset="&START_TIME_LATE_ANALYSIS;">@Y@m@d@H@M00</cyclestr></timedep>
               <or>
                 {%- for h in range(da_cycle_interval_hrs+da_cycle_interval_hrs, 6+1, da_cycle_interval_hrs) %}
                 <datadep age="00:00:01:00"><cyclestr offset="-{{ h }}:00:00">&FG_ROOT;/&RUN;.@Y@m@d/@H/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
                 {%- endfor %}
               </or>
             </and>
           </or>
{%- endif %}
         </and>
       </or>
{%- endif %}
    </dependency>

  </task>

{%- if do_ensemble %}
</metatask>
{%- endif %}

{%- if not do_ensfcst %}
{%- if do_gsiobserver %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&CALC_ENSMEAN_TN;" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_prep_cyc }}">

    &RSRV_ENKF;
    &WALL_LIMIT_RECENTER;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RECENTER_TN;" "&HOMErrfs;/jobs/JRRFS_CALC_ENSMEAN"</command>
    &RESOURCES_RECENTER;
    &NATIVE_ALL;
    <walltime>&WALLTIME_RECENTER;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&CALC_ENSMEAN_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&CALC_ENSMEAN_TN;_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
         <and>
         {%- for m in range(1, num_ens_members+1) %}
         <taskdep task="&PREP_CYC_PROD_TN;_mem{{ "%04d" % m }}"/>
         {%- endfor %}
         </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&OBSERVER_GSI_ENSMEAN_TN;" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_analysis_gsi }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_GSI"</command>
    &RESOURCES_ANALYSIS_GSI;
    &NATIVE_ANALYSIS_GSI;
    <walltime>&WALLTIME_ANALYSIS_GSI;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&OBSERVER_GSI_ENSMEAN_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&OBSERVER_GSI_ENSMEAN_TN;_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>OBSERVER</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEAN</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&GESROOT;/satbias</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <and>
         <taskdep task="&CALC_ENSMEAN_TN;"/>
         {%- if do_enkf_radar_ref %}
         <taskdep task="&PROCESS_RADAR_TN;_prod"/>
         {%- endif %}
	 <or>
           <datadep age="02:00"><cyclestr>&OBSPATH;/@Y@m@d@H.{{obstype_source}}.t@Hz.prepbufr.tm00</cyclestr></datadep>
	   <datadep age="02:00"><cyclestr>&OBSPATH;/{{obstype_source}}.@Y@m@d/{{obstype_source}}.t@Hz.prepbufr.tm00</cyclestr></datadep>
	 </or>
       </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
 {%- if do_ensemble %}
 <metatask name="run_ensemble_observer">
   <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}
    {%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}
    {{- fmtstr%m -}}
   {%- endfor %} </var>
 {%- endif %}

  <task name="&OBSERVER_GSI_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_analysis_gsi }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_GSI"</command>
    &RESOURCES_ANALYSIS_GSI;
    &NATIVE_ANALYSIS_GSI;
    <walltime>&WALLTIME_ANALYSIS_GSI;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&OBSERVER_GSI_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&OBSERVER_GSI_TN;_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>OBSERVER</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&GESROOT;/satbias</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <and>
         <taskdep task="&OBSERVER_GSI_ENSMEAN_TN;"/>
       </and>
    </dependency>

  </task>

{%- if do_ensemble %}
  </metatask>
{%- endif %}
{%- endif %}

{%- if do_enkfupdate %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ENKFUPDT_TN;" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_analysis_enkf }}">
    &RSRV_ENKF;
    &WALL_LIMIT_ANALYSIS;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&ENKFUPDT_TN;" &HOMErrfs;/jobs/JRRFS_ANALYSIS_ENKF</command>

    &RESOURCES_ANALYSIS_ENKF;
    <walltime>&WALLTIME_ANALYSIS_ENKF;</walltime>
    &NODESIZE_ALL;
    <jobname><cyclestr>&TAG;_&ENKFUPDT_TN;</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/&ENKFUPDT_TN;_&TAG;_@Y@m@d@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>OB_TYPE</name><value>conv</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
        <metataskdep metatask="run_ensemble_observer"/>
    </dependency>
  </task>

{%- endif %}

{%- if do_enkf_radar_ref %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ENKF_RADAR_REF_TN;" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_analysis_enkf }}">
    &RSRV_ENKF;
    &WALL_LIMIT_ANALYSIS;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&ENKF_RADAR_REF_TN;" &HOMErrfs;/jobs/JRRFS_ANALYSIS_ENKF</command>

    &RESOURCES_ANALYSIS_ENKF;
    <walltime>&WALLTIME_ANALYSIS_ENKF;</walltime>
    &NODESIZE_ALL;
    <jobname><cyclestr>&TAG;_&ENKF_RADAR_REF_TN;</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/&ENKF_RADAR_REF_TN;_&TAG;_@Y@m@d@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>OB_TYPE</name><value>radardbz</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        <taskdep task="&ENKFUPDT_TN;"/>
        {%- if do_retro %}
        <and> 
        {%- for m in range(1, num_ens_members+1) %}
          <datadep age="00:00:00:01"><cyclestr>&GESROOT;/&RUN;.@Y@m@d/@H/m{{ "%03d" % m }}/observer_gsi/diag_conv_dbz_ges.@Y@m@d@H.nc4.gz</cyclestr></datadep>
        {%- endfor %}
        </and> 
        {%- endif %}
      </and>
    </dependency>
  </task>

{%- endif %}

{% if do_ensemble %}
 <metatask name="run_ensemble">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}{{- fmtstr%m -}}{%- endfor %} </var>
{%- endif %}

{%- if do_dacycle %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ANALYSIS_GSI_TN;_prod{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_analysis_gsi }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_GSI"</command>

    &RESOURCES_ANALYSIS_GSI;
    &NATIVE_ANALYSIS_GSI;
    <walltime>&WALLTIME_ANALYSIS_GSI;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&ANALYSIS_GSI_TN;_prod{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&ANALYSIS_GSI_TN;_&TAG;{{ uscore_ensmem_name }}_prod_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&GESROOT;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    {%- if do_envar_radar_ref and do_envar_radar_ref_once %}
    <envar><name>OB_TYPE</name><value>conv_dbz</value></envar>
    {%- endif %}
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <and>
         <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
         <or>
           <datadep age="02:00"><cyclestr>&OBSPATH;/@Y@m@d@H.{{obstype_source}}.t@Hz.prepbufr.tm00</cyclestr></datadep>
           <datadep age="02:00"><cyclestr>&OBSPATH;/{{obstype_source}}.@Y@m@d/{{obstype_source}}.t@Hz.prepbufr.tm00</cyclestr></datadep>
         </or>
         <taskdep task="&PREP_CYC_TN;_prod{{ uscore_ensmem_name }}"/>
         {%- if use_rrfse_ens %}
         {%- if do_envar_radar_ref and do_envar_radar_ref_once %}
         <taskdep task="&PROCESS_RADAR_TN;_prod"/>
         {%- endif %}
         <or>
           {%- if do_spinup %}
            <and> 
             <or>
             {%- for h in cycl_hrs_prodstart_ens %}
               <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
             </or>
             {% for h in range(1, num_ens_members+1) %}
             <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&RRFSE_FG_ROOT;/&RUN;.@Y@m@d/@H/m{{ "%03d" % h  }}/forecast_spinup/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             {%- endfor %}
            </and>
            <and> 
             {%- for h in cycl_hrs_prodstart_ens %}
               <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
             {%- endfor %}
             {% for h in range(1, num_ens_members+1) %}
             <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&RRFSE_FG_ROOT;/&RUN;.@Y@m@d/@H/m{{ "%03d" % h  }}/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             {%- endfor %}
            </and>
           {%- else %} 
            <and>
             {% for h in range(1, num_ens_members+1) %}
             <datadep age="00:00:01:00"><cyclestr offset="-{{ da_cycle_interval_hrs }}:00:00">&RRFSE_FG_ROOT;/&RUN;.@Y@m@d/@H/m{{ "%03d" % h  }}/forecast/RESTART/</cyclestr><cyclestr>@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
             {%- endfor %}
            </and>
           {%- endif %} 
         </or>
         {%- endif %}
       </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&UPDATE_LBC_SOIL_TN;_prod{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_update_lbc_soil }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_POST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&POST_TN;" "&HOMErrfs;/jobs/JRRFS_UPDATE_LBC_SOIL"</command>
    &RESOURCES_UPDATE_LBC_SOIL;
    &NATIVE_ALL;
    <walltime>&WALLTIME_UPDATE_LBC_SOIL;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&UPDATE_LBC_SOIL_TN;_prod{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&UPDATE_LBC_SOIL_TN;{{ uscore_ensmem_name }}_prod_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&GESROOT;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    {%- if do_envar_radar_ref and do_envar_radar_ref_once %}
    <envar><name>OB_TYPE</name><value>conv_dbz</value></envar>
    {%- endif %}
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <taskdep task="&ANALYSIS_GSI_TN;_prod{{ uscore_ensmem_name }}"/>
    </dependency>

  </task>

{%- if do_envar_radar_ref and not do_envar_radar_ref_once %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&HYBRID_RADAR_REF_TN;_prod" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_analysis_gsi }}">

    &RSRV_ANALYSIS;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&HYBRID_RADAR_REF_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_GSI"</command>
    &RESOURCES_ANALYSIS_GSI;
    &NATIVE_ANALYSIS_GSI;
    <walltime>&WALLTIME_ANALYSIS_GSI;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&HYBRID_RADAR_REF_TN;_prod</jobname>
    <join><cyclestr>&LOGDIR;/&HYBRID_RADAR_REF_TN;_prod_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>RRFSE_FG_ROOT</name><value><cyclestr>&RRFSE_FG_ROOT;</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&GESROOT;/satbias</cyclestr></value></envar>
    <envar><name>nens</name><value>30</value></envar>
    <envar><name>OB_TYPE</name><value>radardbz</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <and>
         <taskdep task="&PROCESS_RADAR_TN;_prod"/>
         <taskdep task="&ANALYSIS_GSI_TN;_prod"/>
         <or>    
            {%- for h in cycl_hrs_hyb_fv3lam_ens %}
               <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
            {%- endfor %}
         </or>   
       </and>
    </dependency>

  </task>

{% endif -%}

{%- if do_gsidiag_offline %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ANALYSIS_GSIDIAG_TN;_prod" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_analysis_gsi }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_GSIDIAG"</command>
    &RESOURCES_ANALYSIS_GSIDIAG;
    &NATIVE_ALL;
    <walltime>&WALLTIME_ANALYSIS_GSIDIAG;</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&ANALYSIS_GSIDIAG_TN;_prod</jobname>
    <join><cyclestr>&LOGDIR;/&ANALYSIS_GSIDIAG_TN;prod_&TAG;@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>GSI_TYPE</name><value><cyclestr>ANALYSIS</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>SATBIAS_DIR</name><value><cyclestr>&GESROOT;/satbias</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
       <and>
         <taskdep task="&ANALYSIS_GSI_TN;_prod"/>
{%- if do_envar_radar_ref and not do_envar_radar_ref_once %}
         <taskdep task="&HYBRID_RADAR_REF_TN;_prod"/>
{%- endif %}
       </and>
    </dependency>

  </task>

{%- endif %}

{% endif -%}

{%- if do_analysis_nonvarcld %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&ANALYSIS_NONVARCLD_TN;_prod{{ uscore_ensmem_name }}" cycledefs="prodcyc,prodcyc_long" maxtries="{{ maxtries_analysis_nonvarcld }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_ANALYSIS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANALYSIS_GSI_TN;" "&HOMErrfs;/jobs/JRRFS_ANALYSIS_NONVARCLD"</command>

    &RESOURCES_ANALYSIS_NONVARCLD;
    <walltime>&WALLTIME_ANALYSIS_NONVARCLD;</walltime>
    {%- if is_rtma %}
    {%- if machine in ["WCOSS2"]  %}
    &NATIVE_ANALYSIS_NONVARCLD;
    {%- else %}
    &NATIVE_ALL;
    {%- endif %}
    {%- else %}
    &NATIVE_ALL;
    {%- endif %}
    &NODESIZE_ALL;

    <jobname>&TAG;_&ANALYSIS_NONVARCLD_TN;_prod{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&ANALYSIS_NONVARCLD_TN;_prod_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>MEM_TYPE</name><value><cyclestr>MEMBER</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <and>
        <taskdep task="&PROCESS_BUFR_TN;_prod"/>
        {%- if do_enkfupdate %}
        <and>
           {%- if do_enkf_radar_ref %}
             <taskdep task="&ENKF_RADAR_REF_TN;"/>
           {%- else %}
             <taskdep task="&ENKFUPDT_TN;"/>
           {%- endif %}
        </and>
        {%- elif do_envar_radar_ref and not do_envar_radar_ref_once %}
        <or>
          <and>
            <taskdep task="&UPDATE_LBC_SOIL_TN;_prod{{ uscore_ensmem_name }}"/>
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
             {%- endfor %}
          </and>
          <and>
	    <taskdep task="&HYBRID_RADAR_REF_TN;_prod"/>
            <or>    
             {%- for h in cycl_hrs_hyb_fv3lam_ens %}
                <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
             {%- endfor %}
            </or>   
          </and>
        </or>
        {%- else %}
	<taskdep task="&UPDATE_LBC_SOIL_TN;_prod{{ uscore_ensmem_name }}"/>
        {%- endif %}
      </and>
    </dependency>

  </task>

{%- endif %}

{%- if do_ensemble %}
 </metatask>
{%- endif %}
{%- endif %}

{%- if do_recenter %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&RECENTER_TN;" cycledefs="recentercyc" maxtries="{{ maxtries_recenter }}">
    &RSRV_ENKF;
    &WALL_LIMIT_RECENTER;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&RECENTER_TN;" &HOMErrfs;/jobs/JRRFS_RECENTER</command>
    &RESOURCES_RECENTER;
    &NATIVE_ALL;
    <walltime>&WALLTIME_RECENTER;</walltime>
    &NODESIZE_ALL;
    <jobname><cyclestr>&TAG;_&RECENTER_TN;</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/&RECENTER_TN;_&TAG;_@Y@m@d@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>

    <envar><name>nens</name><value>{{ num_ens_members }}</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>ENSCTRL_DATAROOT</name><value>&ENSCTRL_DATAROOT;</value></envar>
    <envar><name>ENSCTRL_GESROOT</name><value>&ENSCTRL_GESROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
        {%- if do_ensfcst %}
          <and>
          {%- for m in range(1, num_ens_members+1) %}
            <taskdep task="&PREP_CYC_TN;_prod_mem{{ "%04d" % m }}"/>
          {%- endfor %}
            <datadep age="00:00:05:00"><cyclestr>&ENSCTRL_GESROOT;/&RUN;.@Y@m@d/@H/forecast/INPUT/coupler.res</cyclestr></datadep>
          </and>
        {%- else %}
         <and>
          {%- if do_analysis_nonvarcld %}
          <and>
          {%- for m in range(1, num_ens_members+1) %}
            <taskdep task="&ANALYSIS_NONVARCLD_TN;_prod_mem{{ "%04d" % m }}"/>
          {%- endfor %}
          </and>
          {%- elif do_enkf_radar_ref %}
          <taskdep task="&ENKF_RADAR_REF_TN;"/>
          {%- elif do_enkfupdate %}
          <taskdep task="&ENKFUPDT_TN;"/>
          {%- endif %}
          <or>
          <datadep age="00:00:00:05"><cyclestr>&ENSCTRL_COMOUT;/@H/analysis_nonvarcld_complete.txt</cyclestr></datadep>
          <datadep age="00:00:00:05"><cyclestr>&ENSCTRL_COMOUT;/@H_spinup/analysis_nonvarcld_complete.txt</cyclestr></datadep>
          </or>
         </and>
        {% endif %}
    </dependency>
  </task>

{%- endif %}

{%- if do_save_da_output and do_ensemble %}
<!--
************************************************************************
************************************************************************
-->
 <metatask name="save_ensda_output">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members_fcst+1) -%}{%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}{{- fmtstr%m -}}{%- endfor %} </var>

  <task name="&SAVE_DA_OUTPUT_TN;_prod{{ uscore_ensmem_name }}" cycledefs="savedacyc" maxtries="{{ maxtries_save_da_output }}">

    &RSRV_DEFAULT;
    &WALL_LIMIT_SAVE_RESTART;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&SAVE_RESTART_TN;" "&HOMErrfs;/jobs/JRRFS_SAVE_DA_OUTPUT"</command>
    <nodes>{{ nnodes_save_restart }}:ppn={{ ppn_save_restart }}</nodes>
    <walltime>{{ wtime_save_restart }}</walltime>
    &NODESIZE_ALL;
    <memory>{{ memo_save_da_output }}</memory>
    <jobname>&TAG;_&SAVE_DA_OUTPUT_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&SAVE_DA_OUTPUT_TN;_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>{{ ensmem_indx_name }}</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    {%- if do_ensfcst %}
    <envar><name>CYCLE_TYPE</name><value><cyclestr>enfcst</cyclestr></value></envar>
    {%- else %}
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    {%- endif %}
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
    {%- if do_ensfcst %}
          <taskdep task="&RECENTER_TN;"/>
    {%- else %}
       {%- if do_recenter %}
        <or>
         <and>
          <or>
          {%- for h in cycl_hrs_recenter %}
          <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
          {%- endfor %}
          </or>
          <taskdep task="&RECENTER_TN;"/>
         </and>
         <and>
          {%- for h in cycl_hrs_recenter %}
          <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
          {%- endfor %}
          <taskdep task="&ANALYSIS_NONVARCLD_TN;_prod{{ uscore_ensmem_name }}"/>
         </and>
        </or>
        {%- elif do_analysis_nonvarcld%}
        <taskdep task="&ANALYSIS_NONVARCLD_TN;_prod{{ uscore_ensmem_name }}"/>
        {%- elif do_enkf_radar_ref %}
        <taskdep task="&ENKF_RADAR_REF_TN;"/>
        {%- elif do_enkfupdate %}
        <taskdep task="&ENKFUPDT_TN;"/>
       {%- endif %}
    {%- endif %}
    </dependency>

  </task>
 </metatask>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
{% if do_ensemble %}
 <metatask name="run_ensemble">
  <var name="{{ ensmem_indx_name }}">
    {%- for m in range(1, num_ens_members+1) -%}{%- set fmtstr=" %0"~ndigits_ensmem_names~"d" -%}{{- fmtstr%m -}}{%- endfor %} </var>
{%- endif %}
  <task name="&FORECAST_TN;_prod{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="{{ maxtries_forecast }}">

    &RSRV_FORECAST;
    &WALL_LIMIT_FORECAST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&FORECAST_TN;" "&HOMErrfs;/jobs/JRRFS_FORECAST"</command>

    &RESOURCES_FORECAST_PROD;
    <walltime>&WALLTIME_FORECAST_PROD;</walltime>
    &NATIVE_ALL;
    &NATIVE_FORECAST_PROD;
    &NODESIZE_ALL;
    <jobname>&TAG;_&FORECAST_TN;_prod{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&FORECAST_TN;_prod_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HH</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>RESTART_HRS</name><value><cyclestr>{{ restart_hrs_prod }}</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>
  
    <dependency>
      {%- if do_ensfcst %}
        {%- if do_recenter %}
          <taskdep task="&RECENTER_TN;"/>
        {%- else %}
          <taskdep task="&PREP_CYC_TN;_prod{{ uscore_ensmem_name }}"/>
        {%- endif %}
      {%- else %}
      {%- if do_dacycle and do_analysis_nonvarcld%}
      <taskdep task="&ANALYSIS_NONVARCLD_TN;_prod"/>
      {%- elif do_dacycle %}
        {%- if do_envar_radar_ref and not do_envar_radar_ref_once %}
        <taskdep task="&HYBRID_RADAR_REF_TN;_prod"/>
        {%- else  %}
        <taskdep task="&UPDATE_LBC_SOIL_TN;_prod"/>
        {%- endif %}
      {%- elif do_enkfupdate or do_enkf_radar_ref %}
        {%- if do_recenter %}
        <or>
         <and>
          <or>
          {%- for h in cycl_hrs_recenter %}
          <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
          {%- endfor %}
          </or>
          <taskdep task="&RECENTER_TN;"/>
         </and>
         <and>
          {%- for h in cycl_hrs_recenter %}
          <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
          {%- endfor %}
          <taskdep task="&ANALYSIS_NONVARCLD_TN;_prod{{ uscore_ensmem_name }}"/>
         </and>
        </or>
        {%- elif do_analysis_nonvarcld%}
        <taskdep task="&ANALYSIS_NONVARCLD_TN;_prod{{ uscore_ensmem_name }}"/>
        {%- elif do_enkf_radar_ref %}
        <taskdep task="&ENKF_RADAR_REF_TN;"/>
        {%- else %}
        <taskdep task="&ENKFUPDT_TN;"/>
       {%- endif %}
      {%- else %}
      <taskdep task="&PREP_CYC_TN;_prod{{ uscore_ensmem_name }}"/>
      {%- endif %}
      {%- endif %}
    </dependency>

  </task>

<!-- ******************************************************************* -->
  <task name="&FORECAST_TN;_prod_long{{ uscore_ensmem_name }}" cycledefs="prodcyc_long" maxtries="{{ maxtries_forecast }}">

    &RSRV_FORECAST;
    &WALL_LIMIT_FORECAST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&FORECAST_TN;" "&HOMErrfs;/jobs/JRRFS_FORECAST"</command>

    &RESOURCES_FORECAST_PROD;
    <walltime>&WALLTIME_FORECAST_PROD_LONG;</walltime>
    &NATIVE_ALL;
    &NATIVE_FORECAST_PROD;
    &NODESIZE_ALL;
    <jobname>&TAG;_&FORECAST_TN;_prod{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&FORECAST_TN;_prod_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HH</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>RESTART_HRS</name><value><cyclestr>{{ restart_hrs_prod_long }}</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>
  
    <dependency>
      {%- if do_dacycle and do_analysis_nonvarcld%}
      <taskdep task="&ANALYSIS_NONVARCLD_TN;_prod"/>
      {%- elif do_dacycle %}
        {%- if do_envar_radar_ref and not do_envar_radar_ref_once %}
        <taskdep task="&HYBRID_RADAR_REF_TN;_prod"/>
        {%- else  %}
        <taskdep task="&UPDATE_LBC_SOIL_TN;_prod"/>
        {%- endif %}
      {%- elif do_enkfupdate or do_enkf_radar_ref %}
        {%- if do_recenter %}
        <or>
         <and>
          <or>
          {%- for h in cycl_hrs_recenter %}
          <streq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></streq>
          {%- endfor %}
          </or>
          <taskdep task="&RECENTER_TN;"/>
         </and>
         <and>
          {%- for h in cycl_hrs_recenter %}
          <strneq><left>{{ h }}</left><right><cyclestr>@H</cyclestr></right></strneq>
          {%- endfor %}
          <taskdep task="&ANALYSIS_NONVARCLD_TN;_prod{{ uscore_ensmem_name }}"/>
         </and>
        </or>
        {%- elif do_analysis_nonvarcld%}
        <taskdep task="&ANALYSIS_NONVARCLD_TN;_prod{{ uscore_ensmem_name }}"/>
        {%- elif do_enkf_radar_ref %}
        <taskdep task="&ENKF_RADAR_REF_TN;"/>
        {%- else %}
        <taskdep task="&ENKFUPDT_TN;"/>
       {%- endif %}
      {%- else %}
      <taskdep task="&PREP_CYC_TN;_prod{{ uscore_ensmem_name }}"/>
      {%- endif %}
    </dependency>

  </task>

{%- if not do_ensfcst %}
{%- if not is_rtma %}
<!--
************************************************************************
************************************************************************
-->
  <metatask name="&SAVE_RESTART_TN;_prod">

    <var name="fhr"> {{ restart_hrs_prod }} </var>

    <task name="&SAVE_RESTART_TN;_prod{{ uscore_ensmem_name }}_f#fhr#" cycledefs="prodcyc" maxtries="{{ maxtries_save_restart }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_SAVE_RESTART;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&SAVE_RESTART_TN;" "&HOMErrfs;/jobs/JRRFS_SAVE_RESTART"</command>
      <nodes>{{ nnodes_save_restart }}:ppn={{ ppn_save_restart }}</nodes>
      <walltime>{{ wtime_save_restart }}</walltime>
      &NODESIZE_ALL;
      &MEMO_PREP_CYC;
      <jobname>&TAG;_&SAVE_RESTART_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&SAVE_RESTART_TN;_&TAG;{{ uscore_ensmem_name }}_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
      <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
      <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
      <envar><name>SURFACE_DIR</name><value>&GESROOT;/surface</value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
      <envar><name>KEEPDATA</name><value>YES</value></envar>

      <dependency>
        <and>
          <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
          <or>
            {%- if do_ensemble %}
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_m#mem#_&envir;_@H/RESTART/coupler.res</cyclestr></datadep>
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_m#mem#_&envir;_@H/RESTART/</cyclestr><cyclestr offset="#fhr#:00:00">@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
            {%- else %}
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_&envir;_@H/RESTART/coupler.res</cyclestr></datadep>
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_&envir;_@H/RESTART/</cyclestr><cyclestr offset="#fhr#:00:00">@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
            {%- endif %}
          </or>
        </and>
      </dependency>

    </task>

  </metatask>
  <metatask name="&SAVE_RESTART_TN;_prod_long">

    <var name="fhr"> {{ restart_hrs_prod_long }} </var>

    <task name="&SAVE_RESTART_TN;_prod_long{{ uscore_ensmem_name }}_f#fhr#" cycledefs="prodcyc_long" maxtries="{{ maxtries_save_restart }}">

      &RSRV_DEFAULT;
      &WALL_LIMIT_SAVE_RESTART;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&SAVE_RESTART_TN;" "&HOMErrfs;/jobs/JRRFS_SAVE_RESTART"</command>
      <nodes>{{ nnodes_save_restart }}:ppn={{ ppn_save_restart }}</nodes>
      <walltime>{{ wtime_save_restart }}</walltime>
      &NODESIZE_ALL;
      &MEMO_PREP_CYC;
      <jobname>&TAG;_&SAVE_RESTART_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&SAVE_RESTART_TN;_&TAG;{{ uscore_ensmem_name }}_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
      <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
      <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
      <envar><name>SURFACE_DIR</name><value><cyclestr>&GESROOT;/surface</cyclestr></value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>CYCLE_TYPE</name><value><cyclestr>prod</cyclestr></value></envar>
      <envar><name>KEEPDATA</name><value>YES</value></envar>

      <dependency>
        <and>
          <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
          <or>
            {%- if do_ensemble %}
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_m#mem#_&envir;_@H/RESTART/coupler.res</cyclestr></datadep>
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_m#mem#_&envir;_@H/RESTART/</cyclestr><cyclestr offset="#fhr#:00:00">@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
            {%- else %}
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_&envir;_@H/RESTART/coupler.res</cyclestr></datadep>
              <datadep age="00:30"><cyclestr>&DATAROOT;/&RUN;_forecast_&envir;_@H/RESTART/</cyclestr><cyclestr offset="#fhr#:00:00">@Y@m@d.@H0000.coupler.res</cyclestr></datadep>
            {%- endif %}
          </or>
        </and>
      </dependency>

    </task>

  </metatask>
{%- endif %}
{%- endif %}

{%- if do_post_prod %}
<!--
************************************************************************
************************************************************************
-->
  <metatask name="&POST_TN;{{ uscore_ensmem_name }}">

{%- if postproc_nsout_min > 0 %}
  {%- if postproc_nfhmax_hrs < postproc_len_hrs %}
    <var name="fhr"> {{ "000-%02d-%02d" % ( dt_atmos//60,dt_atmos%60 )  }}  {% for h in range(postproc_nsout_min, postproc_nfhmax_hrs*60, postproc_nsout_min) %}{{ " %03d-%02d-00 " % ( h//60,h-(h//60)*60 )  }}{% endfor %} 
                               {%- for h in range(postproc_nfhmax_hrs, postproc_len_hrs+1, postproc_nfhout_hrs) %}{{ " %03d-00-00 " % h }}{% endfor %} </var> 
  {%- else %}
    <var name="fhr"> {{ "000-%02d-%02d" % ( dt_atmos//60,dt_atmos%60 )  }} {% for h in range(postproc_nsout_min, postproc_len_hrs*60+1, postproc_nsout_min) %}{{ " %03d-%02d-00 " % ( h//60,h-(h//60)*60 )  }}{% endfor %} </var>
  {%- endif %}
{%- else %}
  {%- if postproc_nfhmax_hrs < postproc_len_hrs %}
    <var name="fhr"> {% for h in range(0, postproc_nfhmax_hrs,postproc_nfhout_hf_hrs) %}{{ " %03d" % h  }}{% endfor %}
                     {%- for h in range(postproc_nfhmax_hrs, postproc_len_hrs+1, postproc_nfhout_hrs) %}{{ " %03d " % h }}{% endfor %} </var> 
  {%- else %}
    <var name="fhr"> {% for h in range(0, postproc_len_hrs+1, postproc_nfhout_hf_hrs) %}{{ " %03d" % h  }}{% endfor %} </var>
  {%- endif %}
{%- endif %}

    <task name="&POST_TN;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="prodcyc" maxtries="{{ maxtries_post }}">

      &RSRV_POST;
      &WALL_LIMIT_POST;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&POST_TN;" "&HOMErrfs;/jobs/JRRFS_POST"</command>
      &RESOURCES_POST;
      &NATIVE_ALL;
      <walltime>&WALLTIME_POST;</walltime>
      &NODESIZE_ALL;
      <jobname>&TAG;_&POST_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&POST_TN;_&TAG;{{ uscore_ensmem_name }}_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
      <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
      <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
      <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>KEEPDATA</name><value>YES</value></envar>

      <dependency>
        {%- if do_ensemble %}
          <datadep age="01:30"><cyclestr>&DATAROOT;/&RUN;_forecast_m#mem#_&envir;_@H/log.atm.f#fhr#</cyclestr></datadep>
        {%- else %}
          <datadep age="01:30"><cyclestr>&DATAROOT;/&RUN;_forecast_&envir;_@H/log.atm.f#fhr#</cyclestr></datadep>
        {%- endif %}
      </dependency>

    </task>
  </metatask>

  <metatask name="&POST_TN;{{ uscore_ensmem_name }}_long">

{%- if postproc_nsout_min > 0 %}
  {%- if postproc_nfhmax_hrs < postproc_long_len_hrs %}
    <var name="fhr"> {{ "000-%02d-%02d" % ( dt_atmos//60,dt_atmos%60 )  }} {% for h in range(postproc_nsout_min, postproc_nfhmax_hrs*60, postproc_nsout_min) %}{{ " %03d-%02d-00 " % ( h//60,h-(h//60)*60 )  }}{% endfor %} 
                               {%- for h in range(postproc_nfhmax_hrs, postproc_long_len_hrs+1, postproc_nfhout_hrs) %}{{ " %03d-00-00 " % h }}{% endfor %} </var> 
  {%- else %}
    <var name="fhr"> {{ "000-%02d-%02d" % ( dt_atmos//60,dt_atmos%60 )  }} {% for h in range(postproc_nsout_min, postproc_long_len_hrs*60+1, postproc_nsout_min) %}{{ " %03d-%02d-00 " % ( h//60,h-(h//60)*60 )  }}{% endfor %} </var>
  {%- endif %}
{%- else %}
  {%- if postproc_nfhmax_hrs < postproc_long_len_hrs %}
    <var name="fhr"> {% for h in range(0, postproc_nfhmax_hrs,postproc_nfhout_hf_hrs) %}{{ " %03d" % h  }}{% endfor %}
                     {%- for h in range(postproc_nfhmax_hrs, postproc_long_len_hrs+1, postproc_nfhout_hrs) %}{{ " %03d " % h }}{% endfor %} </var> 
  {%- else %}
    <var name="fhr"> {% for h in range(0, postproc_long_len_hrs+1, postproc_nfhout_hf_hrs) %}{{ " %03d" % h  }}{% endfor %} </var>
  {%- endif %}
{%- endif %}

    <task name="&POST_TN;{{ uscore_ensmem_name }}_f#fhr#_long" cycledefs="prodcyc_long" maxtries="{{ maxtries_post }}">

      &RSRV_POST;
      &WALL_LIMIT_POST;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&POST_TN;" "&HOMErrfs;/jobs/JRRFS_POST"</command>
      &RESOURCES_POST;
      &NATIVE_ALL;
      <walltime>&WALLTIME_POST;</walltime>
      &NODESIZE_ALL;
      <jobname>&TAG;_&POST_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&POST_TN;_&TAG;{{ uscore_ensmem_name }}_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
      <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
      <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
      <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>KEEPDATA</name><value>YES</value></envar>

      <dependency>
          <datadep age="01:30"><cyclestr>&DATAROOT;/&RUN;_forecast_&envir;_@H/log.atm.f#fhr#</cyclestr></datadep>
      </dependency>

    </task>
  </metatask>
<!--
************************************************************************
************************************************************************
-->
<metatask name="&PRDGEN_TN;{{ uscore_ensmem_name }}">

{%- if postproc_nsout_min > 0 %}
  {%- if postproc_nfhmax_hrs < postproc_len_hrs %}
    <var name="fhr"> {{ "000-%02d-%02d" % ( dt_atmos//60,dt_atmos%60 )  }} {% for h in range(postproc_nsout_min, postproc_nfhmax_hrs*60, postproc_nsout_min) %}{{ " %03d-%02d-00 " % ( h//60,h-(h//60)*60 )  }}{% endfor %} 
                               {%- for h in range(postproc_nfhmax_hrs, postproc_len_hrs+1, postproc_nfhout_hrs) %}{{ " %03d-00-00 " % h }}{% endfor %} </var> 
  {%- else %}
    <var name="fhr"> {{ "000-%02d-%02d" % ( dt_atmos//60,dt_atmos%60 )  }} {% for h in range(postproc_nsout_min, postproc_len_hrs*60+1, postproc_nsout_min) %}{{ " %03d-%02d-00 " % ( h//60,h-(h//60)*60 )  }}{% endfor %} </var>
  {%- endif %}
{%- else %}
  {%- if postproc_nfhmax_hrs < postproc_len_hrs %}
    <var name="fhr"> {% for h in range(0, postproc_nfhmax_hrs,postproc_nfhout_hf_hrs) %}{{ " %03d" % h  }}{% endfor %}
                     {%- for h in range(postproc_nfhmax_hrs, postproc_len_hrs+1, postproc_nfhout_hrs) %}{{ " %03d " % h }}{% endfor %} </var> 
  {%- else %}
    <var name="fhr"> {% for h in range(0, postproc_len_hrs+1,postproc_nfhout_hf_hrs) %}{{ " %03d" % h  }}{% endfor %} </var>
  {%- endif %}
{%- endif %}

    <task name="&PRDGEN_TN;{{ uscore_ensmem_name }}_f#fhr#" cycledefs="prodcyc" maxtries="{{ maxtries_prdgen }}">

      &RSRV_PRDGEN;
      &WALL_LIMIT_POST;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&PRDGEN_TN;" "&HOMErrfs;/jobs/JRRFS_PRDGEN"</command>
      &RESOURCES_PRDGEN;
      &NATIVE_ALL;
      <walltime>&WALLTIME_PRDGEN;</walltime>
      &NODESIZE_ALL;
      <memory>&MEMO_PRDGEN;</memory>
      <jobname>&TAG;_&PRDGEN_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&PRDGEN_TN;_&TAG;{{ uscore_ensmem_name }}_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
      <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
      <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>KEEPDATA</name><value>YES</value></envar>

      <dependency>
        <taskdep task="&POST_TN;{{ uscore_ensmem_name }}_f#fhr#"/>
      </dependency>

    </task>
  </metatask>

<metatask name="&PRDGEN_TN;{{ uscore_ensmem_name }}_long">

{%- if postproc_nsout_min > 0 %}
  {%- if postproc_nfhmax_hrs < postproc_long_len_hrs %}
    <var name="fhr"> {{ "000-%02d-%02d" % ( dt_atmos//60,dt_atmos%60 )  }} {% for h in range(postproc_nsout_min, postproc_nfhmax_hrs*60, postproc_nsout_min) %}{{ " %03d-%02d-00 " % ( h//60,h-(h//60)*60 )  }}{% endfor %} 
                               {%- for h in range(postproc_nfhmax_hrs, postproc_long_len_hrs+1, postproc_nfhout_hrs) %}{{ " %03d-00-00 " % h }}{% endfor %} </var> 
  {%- else %}
    <var name="fhr"> {{ "000-%02d-%02d" % ( dt_atmos//60,dt_atmos%60 )  }} {% for h in range(postproc_nsout_min, postproc_long_len_hrs*60+1, postproc_nsout_min) %}{{ " %03d-%02d-00 " % ( h//60,h-(h//60)*60 )  }}{% endfor %} </var>
  {%- endif %}
{%- else %}
  {%- if postproc_nfhmax_hrs < postproc_long_len_hrs %}
    <var name="fhr"> {% for h in range(0, postproc_nfhmax_hrs,postproc_nfhout_hf_hrs) %}{{ " %03d" % h  }}{% endfor %}
                     {%- for h in range(postproc_nfhmax_hrs, postproc_long_len_hrs+1, postproc_nfhout_hrs) %}{{ " %03d " % h }}{% endfor %} </var> 
  {%- else %}
    <var name="fhr"> {% for h in range(0, postproc_long_len_hrs+1, postproc_nfhout_hf_hrs) %}{{ " %03d" % h  }}{% endfor %} </var>
  {%- endif %}
{%- endif %}

    <task name="&PRDGEN_TN;{{ uscore_ensmem_name }}_f#fhr#_long" cycledefs="prodcyc_long" maxtries="{{ maxtries_prdgen }}">

      &RSRV_PRDGEN;
      &WALL_LIMIT_POST;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&PRDGEN_TN;" "&HOMErrfs;/jobs/JRRFS_PRDGEN"</command>
      &RESOURCES_PRDGEN;
      &NATIVE_ALL;
      <walltime>&WALLTIME_PRDGEN;</walltime>
      &NODESIZE_ALL;
      <memory>&MEMO_PRDGEN;</memory>
      <jobname>&TAG;_&PRDGEN_TN;{{ uscore_ensmem_name }}_f#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&PRDGEN_TN;_&TAG;{{ uscore_ensmem_name }}_f#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
      <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
      <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
      <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>KEEPDATA</name><value>YES</value></envar>

      <dependency>
        <taskdep task="&POST_TN;{{ uscore_ensmem_name }}_f#fhr#_long"/>
      </dependency>

    </task>
  </metatask>
{%- endif %}

{% if do_bufrsnd %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&BUFRSND_TN;_long" cycledefs="prodcyc_long" maxtries="1">

    &RSRV_POST;
    &WALL_LIMIT_BUFRSND;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&BUFRSND_TN;" "&HOMErrfs;/jobs/JRRFS_BUFRSND"</command>
    &RESOURCES_BUFRSND;
    <walltime>{{ wtime_bufrsnd }}</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&BUFRSND_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&BUFRSND_TN;_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>tmmark</name><value>tm00</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
{%- if postproc_nsout_min > 0 %}
      <and>
        <datadep age="00:02"><cyclestr>&DATAROOT;/&RUN;_forecast_&envir;_@H/log.atm.f000-00-36</cyclestr></datadep>
        <datadep age="00:02"><cyclestr>&DATAROOT;/&RUN;_forecast_&envir;_@H/log.atm.f000</cyclestr></datadep>
      </and>
{%- endif %}
    </dependency>

  </task>

  {%- if do_ensfcst %}
  <task name="&BUFRSND_TN;{{ uscore_ensmem_name }}" cycledefs="prodcyc" maxtries="1">

    &RSRV_POST;
    &WALL_LIMIT_BUFRSND;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&BUFRSND_TN;" "&HOMErrfs;/jobs/JRRFS_BUFRSND"</command>
    &RESOURCES_BUFRSND;
    <walltime>{{ wtime_bufrsnd }}</walltime>
    &NODESIZE_ALL;
    <jobname>&TAG;_&BUFRSND_TN;{{ uscore_ensmem_name }}</jobname>
    <join><cyclestr>&LOGDIR;/&BUFRSND_TN;_&TAG;{{ uscore_ensmem_name }}_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>DATAROOT</name><value>&DATAROOT;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
    <envar><name>COMROOT</name><value>&COMROOT;</value></envar>
    <envar><name>ENSMEM_INDX</name><value><cyclestr>#{{ ensmem_indx_name }}#</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>tmmark</name><value>tm00</value></envar>
    <envar><name>KEEPDATA</name><value>YES</value></envar>

    <dependency>
      <datadep age="00:02"><cyclestr>&DATAROOT;/&RUN;_forecast_m#mem#_&envir;_@H/log.atm.f000</cyclestr></datadep>
    </dependency>

  </task>
  {%- endif %}

{%- endif %}

{%- if do_ensemble %}
  </metatask>
{%- endif %}
<!--
************************************************************************
************************************************************************
-->
  <task name="&CLEAN_TN;" cycledefs="prodcyc" maxtries="{{ maxtries_post }}">

    &RSRV_POST;

    <command>&HOMErrfs;/scripts/exrrfs_clean.ksh</command>
    <nodes> 1:ppn=1</nodes>
    <walltime>00:15:00</walltime>
    <jobname>&TAG;_&CLEAN_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&CLEAN_TN;_&TAG;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>HOMErrfs</name><value>&HOMErrfs;</value></envar>
    <envar><name>GESROOT</name><value>&GESROOT;</value></envar>
{%- if do_ensemble %}
    <envar><name>nens</name><value><cyclestr>{{ num_ens_members }}</cyclestr></value></envar>
{%- else %}
    <envar><name>nens</name><value><cyclestr>0</cyclestr></value></envar>
{%- endif %}

  </task>

</workflow>
